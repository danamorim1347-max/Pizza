<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Master Pizza | PDV & Delivery</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .hidden { display: none !important; }
        .tab-active { border-bottom: 4px solid #ef4444; color: #ef4444; font-weight: 800; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(24px); }
    </style>
</head>
<body>

    <audio id="alerta-som" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <!-- [VIS√ÉO CLIENTE] -->
    <div id="view-cliente" class="max-w-md mx-auto min-h-screen pb-32">
        <header class="bg-white p-6 rounded-b-[45px] shadow-sm text-center relative border-b">
            <img id="cli-logo" src="" class="h-16 w-16 mx-auto mb-2 object-contain hidden rounded-2xl shadow">
            <h1 id="cli-nome" class="text-xl font-black italic uppercase tracking-tighter">Carregando...</h1>
            <div id="cli-status" class="inline-block px-4 py-1 rounded-full text-[9px] font-black mt-2 border italic uppercase"></div>
            <button onclick="abrirAdmin()" class="absolute top-4 right-4 text-gray-200 p-2"><i class="fas fa-cog"></i></button>
        </header>

        <nav id="filtros" class="flex gap-2 p-4 overflow-x-auto no-scrollbar sticky top-0 z-20 glass"></nav>
        <main id="cardapio" class="p-4 space-y-4"></main>

        <div id="cart-fixed" class="fixed bottom-6 left-0 right-0 px-6 hidden z-30">
            <button onclick="abrirCheckout()" class="max-w-md mx-auto w-full bg-red-600 text-white py-5 rounded-[25px] font-black flex justify-between px-8 shadow-2xl items-center border-b-4 border-red-800">
                <span>VER SACOLA</span>
                <span id="cart-total-display" class="bg-white/20 px-3 py-1 rounded-lg text-sm">R$ 0,00</span>
            </button>
        </div>
    </div>

    <!-- [MODAL CHECKOUT] -->
    <div id="modal-checkout" class="fixed inset-0 bg-black/80 z-50 hidden flex items-end">
        <div class="bg-white w-full max-w-md mx-auto rounded-t-[40px] p-6 space-y-4 max-h-[94vh] overflow-y-auto">
            <div class="flex justify-between items-center">
                <h2 class="font-black italic uppercase italic">Finalizar Pedido</h2>
                <button onclick="fecharCheckout()" class="p-2 text-gray-400">‚úï</button>
            </div>

            <!-- RESUMO DOS PRODUTOS -->
            <div class="bg-gray-50 p-4 rounded-3xl border border-gray-200">
                <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2">Itens Selecionados</p>
                <div id="checkout-itens-list" class="space-y-2"></div>
            </div>
            
            <div class="space-y-3">
                <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Informa√ß√µes de Entrega</p>
                <input id="f-nome" type="text" placeholder="Seu Nome Completo" class="w-full p-4 bg-gray-50 rounded-2xl outline-none border focus:border-red-500">
                
                <!-- GPS OBRIGAT√ìRIO -->
                <button id="btn-gps-cli" onclick="obterGPSCliente()" class="w-full bg-black text-white p-4 rounded-2xl text-[10px] font-black uppercase tracking-widest flex items-center justify-center gap-2">
                    <i class="fas fa-map-marker-alt"></i> CLIQUE PARA LOCALIZAR SEU ENDERE√áO *
                </button>
                
                <div id="res-km" class="hidden bg-green-50 p-4 rounded-2xl flex justify-between text-[10px] font-black text-green-700 border border-green-100">
                    <span id="dist-txt">0.0 km</span><span id="taxa-txt">R$ 0,00</span>
                </div>
                
                <div class="grid grid-cols-4 gap-2">
                    <input id="f-rua" type="text" placeholder="Rua" class="col-span-3 p-4 bg-gray-50 rounded-2xl outline-none border">
                    <input id="f-num" type="text" placeholder="N¬∫" class="col-span-1 p-4 bg-gray-50 rounded-2xl outline-none border text-center">
                </div>
                <input id="f-bairro" type="text" placeholder="Bairro" class="w-full p-4 bg-gray-50 rounded-2xl outline-none border">
                <input id="f-comp" type="text" placeholder="Refer√™ncia (Apto, Casa...)" class="w-full p-4 bg-gray-50 rounded-2xl outline-none border">
            </div>

            <select id="f-pag" onchange="document.getElementById('div-troco').classList.toggle('hidden', this.value!='Dinheiro')" class="w-full p-4 bg-gray-50 rounded-2xl font-bold border">
                <option value="Pix">Pix</option>
                <option value="Cart√£o">Cart√£o</option>
                <option value="Dinheiro">Dinheiro</option>
            </select>
            
            <div id="div-troco" class="hidden">
                <input id="f-troco" type="number" placeholder="Troco para quanto?" class="w-full p-4 bg-orange-50 border-2 border-orange-100 rounded-2xl font-bold">
            </div>

            <div class="bg-gray-900 text-white p-5 rounded-[35px] shadow-xl">
                <div class="flex justify-between text-xl font-black text-red-500 italic uppercase">
                    <span>Total com Frete:</span>
                    <span id="res-total">R$ 0,00</span>
                </div>
            </div>
            
            <button onclick="enviarPedido()" id="btn-final-zap" class="w-full bg-green-600 text-white py-5 rounded-[25px] font-black uppercase tracking-widest shadow-lg border-b-4 border-green-800 transition-all">
                <i class="fab fa-whatsapp mr-1"></i> CONCLUIR E ENVIAR
            </button>
        </div>
    </div>

    <!-- [PAINEL ADM] -->
    <div id="view-admin" class="hidden bg-gray-50 min-h-screen pb-20">
        <header class="bg-black text-white p-4 flex justify-between items-center sticky top-0 z-50">
            <h1 class="font-black italic text-red-500 uppercase">Gest√£o ADM</h1>
            <button onclick="location.reload()" class="text-[10px] font-bold border px-3 py-1 rounded-full uppercase">Sair</button>
        </header>

        <div class="flex bg-white border-b sticky top-14 z-40 shadow-sm overflow-x-auto no-scrollbar">
            <button onclick="switchTab('pedidos')" id="tab-pedidos" class="flex-1 p-4 font-bold text-[10px] tab-active uppercase">Pedidos</button>
            <button onclick="switchTab('produtos')" id="tab-produtos" class="flex-1 p-4 font-bold text-[10px] uppercase">Card√°pio</button>
            <button onclick="switchTab('config')" id="tab-config" class="flex-1 p-4 font-bold text-[10px] uppercase">Loja</button>
        </div>

        <div id="adm-content" class="p-4 max-w-md mx-auto space-y-6">
            <div id="sec-pedidos" class="space-y-4"></div>
            <div id="sec-produtos" class="hidden space-y-4">
                <div id="adm-lista-produtos" class="space-y-4"></div>
            </div>
            <div id="sec-config" class="hidden space-y-4">
                <div class="bg-white p-6 rounded-[35px] shadow-sm space-y-4">
                    <button onclick="obterGPSLoja()" id="btn-gps-loja" class="w-full text-white p-4 rounded-2xl text-[10px] font-black uppercase">üìç Definir Localiza√ß√£o da Loja</button>
                    <input id="adm-nome" type="text" placeholder="Nome da Loja" class="w-full p-3 border rounded-xl">
                    <input id="adm-zap" type="text" placeholder="WhatsApp (DDD+N√∫mero)" class="w-full p-3 border rounded-xl">
                    <div class="flex gap-2">
                        <input id="adm-base" type="number" placeholder="Taxa Base R$" class="flex-1 p-3 border rounded-xl">
                        <input id="adm-km" type="number" placeholder="Valor por KM R$" class="flex-1 p-3 border rounded-xl">
                    </div>
                    <input id="adm-logo" type="text" placeholder="URL da Logo PNG" class="w-full p-3 border rounded-xl">
                    <button onclick="salvarConfig()" class="w-full bg-black text-white p-4 rounded-2xl font-black text-xs uppercase">Salvar Configura√ß√µes</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = "https://psqssqfyqqlumdllmosg.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBzcXNzcWZ5cXFsdW1kbGxtb3NnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMjEwNzMsImV4cCI6MjA4MjY5NzA3M30.fzrGu0P0gSjP3SDoNiM3qnceSKyuMngry42zGqlJRpQ";
        const _sb = supabase.createClient(SB_URL, SB_KEY);

        let PRODS = [], CATS = [], CARRINHO = [], CONFIG = {};
        let dKM = 0, tFRETE = 0, latCli = 0, lngCli = 0, gpsOk = false;

        async function init() {
            const { data: c } = await _sb.from('configuracoes').select('*').single();
            CONFIG = c;
            
            document.getElementById('cli-nome').innerText = c.nome_pizzaria;
            document.getElementById('cli-status').innerText = c.loja_aberta ? '‚óè ABERTO' : '‚óã FECHADO';
            document.getElementById('cli-status').className = c.loja_aberta ? 'inline-block px-4 py-1 rounded-full text-[9px] font-black mt-2 border italic uppercase text-green-600 bg-green-50' : 'inline-block px-4 py-1 rounded-full text-[9px] font-black mt-2 border italic uppercase text-gray-400 bg-gray-50';
            if(c.logo_url) { document.getElementById('cli-logo').src = c.logo_url; document.getElementById('cli-logo').classList.remove('hidden'); }

            document.getElementById('adm-nome').value = c.nome_pizzaria;
            document.getElementById('adm-zap').value = c.whatsapp;
            document.getElementById('adm-base').value = c.taxa_base;
            document.getElementById('adm-km').value = c.preco_km;
            document.getElementById('adm-logo').value = c.logo_url || "";
            
            const btnGPS = document.getElementById('btn-gps-loja');
            btnGPS.classList.add(c.lat_pizzaria ? 'bg-green-600' : 'bg-red-500');

            loadData();
            _sb.channel('realtime').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'pedidos' }, () => {
                document.getElementById('alerta-som').play();
                loadPedidos();
            }).subscribe();
        }

        async function loadData() {
            const [{ data: cats }, { data: prods }] = await Promise.all([
                _sb.from('categorias').select('*').order('ordem'),
                _sb.from('produtos').select('*').order('nome')
            ]);
            CATEGORIAS = cats || []; PRODUTOS = prods || [];
            renderFiltros(); renderCardapio('todos');
        }

        function renderFiltros() {
            const div = document.getElementById('filtros');
            div.innerHTML = `<button onclick="renderCardapio('todos')" class="bg-black text-white px-6 py-2 rounded-full font-black text-[10px] italic shadow-lg">TODOS</button>`;
            CATEGORIAS.forEach(c => div.innerHTML += `<button onclick="renderCardapio('${c.id}')" class="bg-white text-gray-400 border px-6 py-2 rounded-full font-black text-[10px] uppercase shadow-sm">${c.nome}</button>`);
        }

        function renderCardapio(cid) {
            const div = document.getElementById('cardapio'); div.innerHTML = "";
            const f = cid === 'todos' ? PRODUTOS : PRODUTOS.filter(p => p.categoria_id === cid);
            f.forEach(p => {
                if(!p.disponivel) return;
                div.innerHTML += `
                    <div class="bg-white rounded-[35px] shadow-sm p-4 flex gap-4 border border-gray-50 items-center">
                        <img src="${p.imagem_url || ''}" class="w-16 h-16 object-contain rounded-xl">
                        <div class="flex-1">
                            <h3 class="font-black text-xs uppercase italic">${p.nome}</h3>
                            <p class="text-[9px] text-gray-400 line-clamp-1">${p.descricao || ''}</p>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-red-600 font-black text-lg italic font-extrabold">R$ ${Number(p.preco).toFixed(2).replace('.', ',')}</span>
                                <button onclick="addCart('${p.id}')" class="bg-yellow-400 text-black w-9 h-9 rounded-xl font-black text-xl shadow-lg active:scale-95 transition">+</button>
                            </div>
                        </div>
                    </div>`;
            });
        }

        function addCart(id) {
            if(!CONFIG.loja_aberta) return alert("Estamos Fechados!");
            const p = PRODUTOS.find(i => i.id === id);
            CARRINHO.push(p);
            const total = CARRINHO.reduce((a, i) => a + Number(i.preco), 0);
            document.getElementById('cart-total-display').innerText = `R$ ${total.toFixed(2).replace('.', ',')}`;
            document.getElementById('cart-fixed').classList.remove('hidden');
        }

        function abrirCheckout() { 
            document.getElementById('modal-checkout').classList.remove('hidden'); 
            
            // PREENCHER DADOS SALVOS
            document.getElementById('f-nome').value = localStorage.getItem('p_nome') || "";
            document.getElementById('f-rua').value = localStorage.getItem('p_rua') || "";
            document.getElementById('f-num').value = localStorage.getItem('p_num') || "";
            document.getElementById('f-bairro').value = localStorage.getItem('p_bairro') || "";
            document.getElementById('f-comp').value = localStorage.getItem('p_comp') || "";

            // MOSTRAR PRODUTOS NA LISTA DO CHECKOUT
            const listDiv = document.getElementById('checkout-itens-list');
            listDiv.innerHTML = CARRINHO.map(item => `
                <div class="flex justify-between items-center text-[11px] bg-white p-2 rounded-xl border border-gray-100">
                    <span class="font-bold text-gray-700">1x ${item.nome}</span>
                    <span class="text-red-600 font-black">R$ ${Number(item.preco).toFixed(2)}</span>
                </div>
            `).join('');

            renderCheckoutTotal(); 
        }

        function fecharCheckout() { document.getElementById('modal-checkout').classList.add('hidden'); }

        function renderCheckoutTotal() {
            const sub = CARRINHO.reduce((a, i) => a + Number(i.preco), 0);
            document.getElementById('res-total').innerText = `R$ ${(sub + tFRETE).toFixed(2).replace('.', ',')}`;
        }

        function obterGPSCliente() {
            const b = document.getElementById('btn-gps-cli'); 
            b.innerText = "‚è≥ LOCALIZANDO...";
            navigator.geolocation.getCurrentPosition(pos => {
                latCli = pos.coords.latitude; lngCli = pos.coords.longitude;
                const lat1 = Number(CONFIG.lat_pizzaria), lon1 = Number(CONFIG.lng_pizzaria);
                const R = 6371; const dLat = (latCli-lat1)*Math.PI/180; const dLon = (lngCli-lon1)*Math.PI/180;
                const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(latCli*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
                dKM = R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
                tFRETE = Number(CONFIG.taxa_base) + (dKM * Number(CONFIG.preco_km));
                
                document.getElementById('res-km').classList.remove('hidden');
                document.getElementById('dist-txt').innerText = `${dKM.toFixed(1)} km`;
                document.getElementById('taxa-txt').innerText = `R$ ${tFRETE.toFixed(2)}`;
                b.innerText = "‚úÖ FRETE CALCULADO"; b.className = "w-full bg-green-600 text-white p-4 rounded-2xl text-[10px] font-black uppercase";
                gpsOk = true;
                renderCheckoutTotal();
            }, () => {
                alert("Ative o GPS para calcular o valor da entrega corretamente!");
                b.innerText = "‚ùå ERRO AO LOCALIZAR";
            });
        }

        async function enviarPedido() {
            const nome = document.getElementById('f-nome').value;
            const rua = document.getElementById('f-rua').value;
            const num = document.getElementById('f-num').value;
            const bairro = document.getElementById('f-bairro').value;
            const comp = document.getElementById('f-comp').value;
            const pag = document.getElementById('f-pag').value;
            const troco = document.getElementById('f-troco').value || "N√£o precisa";
            const totalStr = document.getElementById('res-total').innerText;

            if(!gpsOk) return alert("A localiza√ß√£o por GPS √© obrigat√≥ria para calcular o frete!");
            if(!nome || !rua || !num || !bairro) return alert("Por favor, preencha o endere√ßo completo!");

            // Salvar mem√≥ria
            localStorage.setItem('p_nome', nome); localStorage.setItem('p_rua', rua);
            localStorage.setItem('p_num', num); localStorage.setItem('p_bairro', bairro); localStorage.setItem('p_comp', comp);

            // Inserir no Banco
            const { data: ped } = await _sb.from('pedidos').insert([{
                cliente_nome: nome, rua, numero: num, bairro, complemento: comp, 
                distancia_km: dKM, taxa_entrega: tFRETE, total: Number(totalStr.replace('R$ ', '').replace(',','.')), 
                pagamento: pag, troco: troco
            }]).select();

            if(ped) {
                const itensBD = CARRINHO.map(i => ({ pedido_id: ped[0].id, produto_nome: i.nome, preco: i.preco }));
                await _sb.from('itens_pedido').insert(itensBD);

                // Montar Mensagem WhatsApp
                const itensTxt = CARRINHO.map(i => `‚Ä¢ 1x *${i.nome}*`).join('\n');
                const cleanZap = CONFIG.whatsapp.replace(/\D/g, ''); // Garante s√≥ n√∫meros
                
                const textoFinal = 
                    `*NOVO PEDIDO - ${CONFIG.nome_pizzaria.toUpperCase()}*\n` +
                    `--------------------------------\n` +
                    `*CLIENTE:* ${nome}\n` +
                    `*ENDERE√áO:* ${rua}, ${num} - ${bairro}\n` +
                    `*REF:* ${comp}\n` +
                    `--------------------------------\n` +
                    `*ITENS:*\n${itensTxt}\n` +
                    `--------------------------------\n` +
                    `*FRETE:* R$ ${tFRETE.toFixed(2)} (${dKM.toFixed(1)}km)\n` +
                    `*TOTAL:* ${totalStr}\n` +
                    `--------------------------------\n` +
                    `*PAGAMENTO:* ${pag}\n` +
                    `*TROCO:* ${troco}\n` +
                    `--------------------------------\n` +
                    `üìç *MAPA DA ENTREGA:* \nhttps://www.google.com/maps?q=${latCli},${lngCli}`;

                const encodeMsg = encodeURIComponent(textoFinal);
                window.open(`https://api.whatsapp.com/send?phone=${cleanZap}&text=${encodeMsg}`);
                location.reload();
            }
        }

        // --- ADM ---
        function abrirAdmin() { if(prompt("Senha:") === "123") { document.getElementById('view-cliente').classList.add('hidden'); document.getElementById('view-admin').classList.remove('hidden'); switchTab('pedidos'); } }
        async function switchTab(t) {
            ['pedidos', 'produtos', 'config'].forEach(tab => {
                document.getElementById(`sec-${tab}`).classList.toggle('hidden', tab !== t);
                document.getElementById(`tab-${tab}`).classList.toggle('tab-active', tab === t);
            });
            if(t === 'pedidos') loadPedidos();
        }

        async function loadPedidos() {
            const { data } = await _sb.from('pedidos').select('*, itens_pedido(*)').order('created_at', { ascending: false }).limit(10);
            const div = document.getElementById('sec-pedidos');
            div.innerHTML = `<h2 class="text-[10px] font-black text-gray-400 uppercase mb-4 tracking-widest">Pedidos Ativos</h2>`;
            data.forEach(p => {
                div.innerHTML += `
                    <div class="bg-white p-4 rounded-3xl shadow-sm border border-l-4 ${p.status === 'Novo' ? 'border-l-red-500' : 'border-l-blue-400'} mb-4">
                        <div class="flex justify-between font-black text-[10px] uppercase"><span>${p.cliente_nome}</span><span class="text-red-500 italic">${p.status}</span></div>
                        <div class="text-[9px] text-gray-500 my-1">${p.rua}, ${p.numero} - ${p.bairro}</div>
                        <div class="text-[9px] font-bold border-y border-dashed py-2 my-2">${p.itens_pedido.map(i => `1x ${i.produto_nome}`).join(', ')}</div>
                        <div class="flex justify-between items-center mt-2">
                            <span class="font-black text-xs">Total: R$ ${p.total.toFixed(2)}</span>
                            <select onchange="updateStatus('${p.id}', this.value)" class="text-[9px] bg-gray-100 p-2 rounded-lg font-bold">
                                <option value="">Alterar</option><option value="Preparando">Preparando</option><option value="Saiu">Saiu</option><option value="Entregue">Entregue</option>
                            </select>
                        </div>
                    </div>`;
            });
        }

        async function updateStatus(id, s) { await _sb.from('pedidos').update({ status: s }).eq('id', id); loadPedidos(); }
        async function obterGPSLoja() {
            navigator.geolocation.getCurrentPosition(async pos => {
                await _sb.from('configuracoes').update({ lat_pizzaria: pos.coords.latitude, lng_pizzaria: pos.coords.longitude }).eq('id', 1);
                alert("Localiza√ß√£o da Loja Atualizada!"); location.reload();
            });
        }
        async function salvarConfig() {
            const n = document.getElementById('adm-nome').value, z = document.getElementById('adm-zap').value;
            const b = document.getElementById('adm-base').value, k = document.getElementById('adm-km').value, l = document.getElementById('adm-logo').value;
            await _sb.from('configuracoes').update({ nome_pizzaria: n, whatsapp: z, taxa_base: b, preco_km: k, logo_url: l }).eq('id', 1);
            alert("Configura√ß√µes Salvas!"); init();
        }

        init();
    </script>
</body>
</html>
