<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Master Pizza | Gest√£o Completa</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #F9FAFB; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .hidden { display: none; }
        .tab-active { border-bottom: 3px solid #ef4444; color: #ef4444; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #ef4444; }
        input:checked + .slider:before { transform: translateX(20px); }
    </style>
</head>
<body>

    <!-- [1] VIS√ÉO CLIENTE -->
    <div id="view-cliente" class="max-w-md mx-auto min-h-screen pb-32">
        <header class="bg-white p-8 rounded-b-[50px] shadow-sm text-center relative border-b border-gray-100">
            <img id="logo-img" src="" class="h-20 w-20 mx-auto mb-3 object-contain hidden rounded-2xl shadow-lg">
            <h1 id="loja-nome" class="text-2xl font-black italic text-gray-900 uppercase">Sua Pizzaria</h1>
            <div id="loja-status" class="inline-flex items-center gap-2 px-4 py-1 rounded-full text-[10px] font-black mt-3 border"></div>
            <button onclick="abrirAdmin()" class="absolute top-4 right-6 text-gray-200">‚öôÔ∏è</button>
        </header>
        <nav id="filtros" class="flex gap-2 p-4 overflow-x-auto no-scrollbar sticky top-0 z-20 bg-white/80 backdrop-blur-md"></nav>
        <main id="cardapio" class="p-4 space-y-4"></main>
        
        <div id="cart-footer" class="fixed bottom-6 left-0 right-0 px-6 hidden z-30">
            <button onclick="abrirCheckout()" class="max-w-md mx-auto w-full bg-red-600 text-white py-5 rounded-[25px] font-black flex justify-between px-8 shadow-2xl items-center border-b-4 border-red-800">
                <span>REVISAR PEDIDO</span>
                <span id="total-flutuante" class="bg-white/20 px-3 py-1 rounded-lg">R$ 0,00</span>
            </button>
        </div>
    </div>

    <!-- [2] MODAL CHECKOUT -->
    <div id="modal-checkout" class="fixed inset-0 bg-black/70 z-50 hidden flex items-end">
        <div class="bg-white w-full max-w-md mx-auto rounded-t-[40px] p-6 space-y-4 max-h-[92vh] overflow-y-auto">
            <div class="flex justify-between items-center"><h2 class="font-black italic uppercase italic">Finalizar</h2><button onclick="fecharCheckout()">‚úï</button></div>
            <input id="f-nome" type="text" placeholder="Seu Nome" class="w-full p-4 bg-gray-50 rounded-2xl outline-none">
            <button id="btn-gps" onclick="obterGPS()" class="w-full bg-gray-900 text-white p-4 rounded-2xl text-[10px] font-black uppercase tracking-widest">üìç Calcular Frete por Dist√¢ncia</button>
            <div id="res-km" class="hidden bg-green-50 p-3 rounded-xl flex justify-between text-[10px] font-black text-green-700">
                <span id="dist-txt">0 km</span><span id="taxa-txt">R$ 0,00</span>
            </div>
            <div class="grid grid-cols-4 gap-2">
                <input id="f-rua" type="text" placeholder="Rua" class="col-span-3 p-4 bg-gray-50 rounded-2xl outline-none">
                <input id="f-num" type="text" placeholder="N¬∫" class="col-span-1 p-4 bg-gray-50 rounded-2xl outline-none text-center">
            </div>
            <input id="f-bairro" type="text" placeholder="Bairro" class="w-full p-4 bg-gray-50 rounded-2xl outline-none">
            <select id="f-pag" onchange="document.getElementById('div-troco').classList.toggle('hidden', this.value!='Dinheiro')" class="w-full p-4 bg-gray-50 rounded-2xl font-bold border-none">
                <option value="Pix">Pix (na entrega)</option>
                <option value="Cart√£o">Cart√£o</option>
                <option value="Dinheiro">Dinheiro</option>
            </select>
            <div id="div-troco" class="hidden">
                <input id="f-troco" type="number" placeholder="Troco para quanto?" class="w-full p-4 bg-orange-50 rounded-2xl font-bold border-2 border-orange-100">
            </div>
            <div class="bg-gray-900 text-white p-5 rounded-[30px]"><div class="flex justify-between text-2xl font-black text-red-500 italic"><span>TOTAL:</span><span id="res-total">R$ 0,00</span></div></div>
            <button onclick="enviarPedido()" class="w-full bg-green-600 text-white py-5 rounded-[25px] font-black uppercase tracking-widest">Enviar Pedido</button>
        </div>
    </div>

    <!-- [3] PAINEL ADM COMPLETO -->
    <div id="view-admin" class="hidden bg-gray-50 min-h-screen pb-20">
        <header class="bg-black text-white p-4 flex justify-between items-center sticky top-0 z-50">
            <h1 class="font-black italic text-red-500">PAINEL ADM</h1>
            <button onclick="location.reload()" class="text-[10px] font-bold border px-3 py-1 rounded-full uppercase">Sair</button>
        </header>

        <!-- Menu do ADM -->
        <div class="flex bg-white border-b sticky top-14 z-40 overflow-x-auto no-scrollbar">
            <button onclick="tabAdm('pedidos')" id="tab-pedidos" class="flex-1 p-4 font-bold text-[10px] tab-active whitespace-nowrap uppercase">Pedidos</button>
            <button onclick="tabAdm('categorias')" id="tab-categorias" class="flex-1 p-4 font-bold text-[10px] whitespace-nowrap uppercase">Categorias</button>
            <button onclick="tabAdm('produtos')" id="tab-produtos" class="flex-1 p-4 font-bold text-[10px] whitespace-nowrap uppercase">Produtos</button>
            <button onclick="tabAdm('config')" id="tab-config" class="flex-1 p-4 font-bold text-[10px] whitespace-nowrap uppercase">Config</button>
        </div>

        <div id="adm-content" class="p-4 max-w-md mx-auto space-y-6">
            
            <!-- ABA PEDIDOS -->
            <div id="sec-pedidos" class="space-y-4">
                <div id="lista-pedidos-adm" class="space-y-4"></div>
            </div>

            <!-- ABA CATEGORIAS (NOVA) -->
            <div id="sec-categorias" class="hidden space-y-4">
                <div class="bg-white p-4 rounded-3xl shadow-sm border space-y-3">
                    <h3 class="font-black text-xs uppercase">Nova Categoria</h3>
                    <input id="new-cat-nome" type="text" placeholder="Nome da Categoria (ex: Doces)" class="w-full p-3 bg-gray-50 rounded-xl outline-none border">
                    <button onclick="criarCategoria()" class="w-full bg-green-600 text-white p-3 rounded-xl font-bold">Adicionar Categoria</button>
                </div>
                <div id="lista-categorias-adm" class="space-y-2"></div>
            </div>

            <!-- ABA PRODUTOS -->
            <div id="sec-produtos" class="hidden space-y-4">
                <div id="adm-lista-produtos" class="space-y-4"></div>
            </div>

            <!-- ABA CONFIG -->
            <div id="sec-config" class="hidden space-y-4">
                <div class="bg-white p-6 rounded-[30px] space-y-4">
                    <div class="flex justify-between items-center bg-gray-50 p-3 rounded-xl">
                        <span class="font-bold text-xs">LOJA ABERTA?</span>
                        <label class="switch"><input type="checkbox" id="adm-check-loja" onchange="toggleLoja(this.checked)"><span class="slider"></span></label>
                    </div>
                    <input id="adm-nome" type="text" placeholder="Nome Loja" class="w-full p-3 border rounded-xl">
                    <input id="adm-zap" type="text" placeholder="WhatsApp 55..." class="w-full p-3 border rounded-xl">
                    <input id="adm-base" type="number" placeholder="Taxa Base" class="w-full p-3 border rounded-xl">
                    <input id="adm-km" type="number" placeholder="Pre√ßo/KM" class="w-full p-3 border rounded-xl">
                    <button onclick="salvarGeral()" class="w-full bg-black text-white p-4 rounded-2xl font-black">SALVAR TUDO</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = "https://psqssqfyqqlumdllmosg.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBzcXNzcWZ5cXFsdW1kbGxtb3NnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMjEwNzMsImV4cCI6MjA4MjY5NzA3M30.fzrGu0P0gSjP3SDoNiM3qnceSKyuMngry42zGqlJRpQ";
        const _sb = supabase.createClient(SB_URL, SB_KEY);

        let PRODS = [], CATS = [], CARRINHO = [], CONFIG = {};
        let dKM = 0, tFrete = 0;

        async function init() {
            const { data: c } = await _sb.from('configuracoes').select('*').single();
            CONFIG = c;
            document.getElementById('loja-nome').innerText = c.nome_pizzaria;
            document.getElementById('loja-status').innerText = c.loja_aberta ? '‚óè ABERTO' : '‚óã FECHADO';
            document.getElementById('adm-check-loja').checked = c.loja_aberta;

            const { data: cats } = await _sb.from('categorias').select('*').order('ordem');
            const { data: prods } = await _sb.from('produtos').select('*').order('nome');
            PRODS = prods || []; CATS = cats || [];
            
            renderFiltros(); renderCardapio('todos'); renderAdminCategorias(); renderAdminProdutos(); carregarPedidos();
        }

        // --- GEST√ÉO DE CATEGORIAS NO ADM ---
        function renderAdminCategorias() {
            const div = document.getElementById('lista-categorias-adm');
            div.innerHTML = CATS.map(c => `
                <div class="bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border">
                    <span class="font-bold text-xs uppercase">${c.nome}</span>
                    <button onclick="deletarCategoria('${c.id}')" class="text-red-500 font-bold text-[10px]">REMOVER</button>
                </div>
            `).join('');
        }

        async function criarCategoria() {
            const nome = document.getElementById('new-cat-nome').value;
            if(!nome) return;
            await _sb.from('categorias').insert([{ nome, ordem: CATS.length + 1 }]);
            location.reload();
        }

        async function deletarCategoria(id) {
            if(!confirm("Cuidado: Isso pode afetar os produtos vinculados. Deletar?")) return;
            await _sb.from('categorias').delete().eq('id', id);
            location.reload();
        }

        // --- GEST√ÉO DE PRODUTOS NO ADM ---
        function renderAdminProdutos() {
            const div = document.getElementById('adm-lista-produtos');
            div.innerHTML = PRODS.map(p => `
                <div class="bg-white p-4 rounded-3xl space-y-3 shadow-sm border">
                    <div class="flex justify-between items-center">
                        <span class="font-black text-[10px] uppercase">${p.nome}</span>
                        <label class="switch"><input type="checkbox" ${p.disponivel ? 'checked' : ''} onchange="toggleDispo('${p.id}', this.checked)"><span class="slider"></span></label>
                    </div>
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <label class="text-[8px] font-bold text-gray-400">CATEGORIA</label>
                            <select id="cat-${p.id}" class="w-full p-2 bg-gray-50 border rounded-lg text-[10px] font-bold">
                                ${CATS.map(c => `<option value="${c.id}" ${p.categoria_id === c.id ? 'selected' : ''}>${c.nome}</option>`).join('')}
                            </select>
                        </div>
                        <div class="w-20">
                            <label class="text-[8px] font-bold text-gray-400">PRE√áO</label>
                            <input id="prc-${p.id}" type="number" step="0.01" value="${p.preco}" class="w-full p-2 border rounded-lg text-center text-xs font-bold">
                        </div>
                    </div>
                    <button onclick="salvarProdutoADM('${p.id}')" class="w-full bg-black text-white p-2 rounded-xl text-[10px] font-bold">SALVAR ALTERA√á√ïES</button>
                </div>
            `).join('');
        }

        async function salvarProdutoADM(id) {
            const p = document.getElementById(`prc-${id}`).value;
            const c = document.getElementById(`cat-${id}`).value;
            await _sb.from('produtos').update({ preco: p, categoria_id: c }).eq('id', id);
            alert("Produto atualizado!");
        }

        async function toggleDispo(id, val) {
            await _sb.from('produtos').update({ disponivel: val }).eq('id', id);
        }

        // --- FUN√á√ïES DE NAVEGA√á√ÉO E LOJA ---
        function tabAdm(t) {
            ['pedidos', 'categorias', 'produtos', 'config'].forEach(tab => {
                document.getElementById(`sec-${tab}`).classList.toggle('hidden', tab !== t);
                document.getElementById(`tab-${tab}`).classList.toggle('tab-active', tab === t);
            });
        }

        function renderFiltros() {
            const n = document.getElementById('filtros');
            n.innerHTML = `<button onclick="renderCardapio('todos')" class="bg-black text-white px-6 py-2 rounded-full font-black text-[10px] italic">TODOS</button>`;
            CATS.forEach(c => n.innerHTML += `<button onclick="renderCardapio('${c.id}')" class="bg-white text-gray-400 border px-6 py-2 rounded-full font-black text-[10px]">${c.nome.toUpperCase()}</button>`);
        }

        function renderCardapio(cid) {
            const div = document.getElementById('cardapio'); div.innerHTML = "";
            const f = cid === 'todos' ? PRODS : PRODS.filter(p => p.categoria_id === cid);
            f.forEach(p => {
                if(!p.disponivel) return;
                div.innerHTML += `<div class="bg-white rounded-[35px] shadow-sm p-4 flex gap-4 border border-gray-50 items-center">
                    <img src="${p.imagem_url || ''}" class="w-16 h-16 object-contain">
                    <div class="flex-1">
                        <h3 class="font-black text-xs uppercase italic">${p.nome}</h3>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-red-600 font-black text-sm italic text-lg">R$ ${Number(p.preco).toFixed(2)}</span>
                            <button onclick="addCart('${p.id}')" class="bg-yellow-400 w-9 h-9 rounded-xl font-black text-xl shadow">+</button>
                        </div>
                    </div>
                </div>`;
            });
        }

        async function salvarGeral() {
            const n = document.getElementById('adm-nome').value;
            const z = document.getElementById('adm-zap').value;
            const b = document.getElementById('adm-base').value;
            const k = document.getElementById('adm-km').value;
            await _sb.from('configuracoes').update({ nome_pizzaria: n, whatsapp: z, taxa_base: b, preco_km: k }).eq('id', 1);
            alert("Salvo!");
            location.reload();
        }

        async function toggleLoja(val) {
            await _sb.from('configuracoes').update({ loja_aberta: val }).eq('id', 1);
        }

        // (Mantenha aqui as fun√ß√µes obterGPS, addCart, renderTotaisCheckout, enviarPedido, carregarPedidos, atualizarStatusPedido, abrirAdmin, abrirCheckout, fecharCheckout do c√≥digo anterior)
        
        function abrirAdmin() { if(prompt("Senha:") === "123") { document.getElementById('view-cliente').classList.add('hidden'); document.getElementById('view-admin').classList.remove('hidden'); } }
        function fecharCheckout() { document.getElementById('modal-checkout').classList.add('hidden'); }
        function abrirCheckout() { document.getElementById('modal-checkout').classList.remove('hidden'); renderTotaisCheckout(); }
        function renderTotaisCheckout() {
            const sub = CARRINHO.reduce((a, i) => a + Number(i.preco), 0);
            document.getElementById('res-total').innerText = `R$ ${(sub + tFrete).toFixed(2)}`;
        }

        function addCart(id) {
            if(!CONFIG.loja_aberta) return alert("Fechado!");
            CARRINHO.push(PRODS.find(i => i.id === id));
            const t = CARRINHO.reduce((a, i) => a + Number(i.preco), 0);
            document.getElementById('total-flutuante').innerText = `R$ ${t.toFixed(2)}`;
            document.getElementById('cart-footer').classList.remove('hidden');
        }

        async function carregarPedidos() {
            const { data: peds } = await _sb.from('pedidos').select('*, itens_pedido(*)').order('created_at', { ascending: false }).limit(20);
            const div = document.getElementById('lista-pedidos-adm');
            div.innerHTML = peds.map(p => `
                <div class="bg-white p-4 rounded-3xl shadow-sm border">
                    <div class="flex justify-between font-black text-[10px]"><span>${p.cliente_nome}</span><span class="text-red-500">${p.status}</span></div>
                    <div class="text-[9px] text-gray-500 py-2 border-b border-dashed">${p.rua}, ${p.numero} - ${p.bairro}</div>
                    <div class="py-2 text-[9px] font-bold">${p.itens_pedido.map(i => `1x ${i.produto_nome}`).join(', ')}</div>
                    <div class="flex justify-between items-center mt-2">
                        <span class="font-black text-xs">R$ ${p.total.toFixed(2)}</span>
                        <select onchange="atualizarStatusPedido('${p.id}', this.value)" class="text-[8px] bg-gray-100 p-1 rounded font-bold">
                            <option value="">Status</option>
                            <option value="Preparando">Preparando</option>
                            <option value="Saiu">Saiu</option>
                            <option value="Entregue">Entregue</option>
                        </select>
                    </div>
                </div>
            `).join('');
        }

        async function atualizarStatusPedido(id, s) {
            await _sb.from('pedidos').update({ status: s }).eq('id', id);
            carregarPedidos();
        }

        init();
    </script>
</body>
</html>
