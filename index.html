<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bella Pizza | Delivery Inteligente</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f9fafb; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .hidden { display: none; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .btn-active { transform: scale(0.96); }
        
        @media print {
            body * { visibility: hidden; }
            #secao-impressao, #secao-impressao * { visibility: visible; }
            #secao-impressao { position: absolute; left: 0; top: 0; width: 100%; border: none; font-size: 12px; }
        }

        /* Toggle ADM Style */
        .switch { position: relative; display: inline-block; width: 44px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 22px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #ef4444; }
        input:checked + .slider:before { transform: translateX(22px); }
    </style>
</head>
<body>

    <!-- [1] VIS√ÉO CLIENTE -->
    <div id="view-cliente" class="max-w-md mx-auto min-h-screen pb-32">
        <header class="bg-white p-6 rounded-b-[40px] shadow-sm text-center relative border-b border-gray-100">
            <div class="flex justify-center mb-3">
                <img id="logo-img" src="" class="h-20 w-20 object-contain hidden rounded-2xl shadow-lg">
                <div id="logo-placeholder" class="h-20 w-20 bg-red-600 rounded-2xl flex items-center justify-center text-white text-4xl font-black shadow-xl">P</div>
            </div>
            <h1 id="loja-nome" class="text-xl font-extrabold text-gray-900 italic tracking-tight uppercase">Sua Pizzaria</h1>
            <div id="loja-status" class="inline-flex items-center gap-2 px-4 py-1 rounded-full text-[9px] font-black mt-3 border"></div>
            <button onclick="entrarAdmin()" class="absolute top-4 right-6 text-gray-200 text-xl">‚öôÔ∏è</button>
        </header>

        <nav id="filtros" class="flex gap-2 p-4 overflow-x-auto no-scrollbar sticky top-0 z-20 glass"></nav>

        <main id="cardapio" class="p-4 space-y-4">
            <div class="text-center py-20 text-gray-400 italic">Preparando o forno...</div>
        </main>

        <!-- Carrinho Flutuante -->
        <div id="cart-fixed" class="fixed bottom-6 left-0 right-0 px-6 hidden z-30">
            <button onclick="abrirCheckout()" class="max-w-md mx-auto w-full bg-red-600 text-white py-5 rounded-[25px] font-black flex justify-between px-8 shadow-2xl items-center border-b-4 border-red-800">
                <span class="text-xs uppercase tracking-widest">Revisar Pedido</span>
                <span id="cart-total-btn" class="bg-white/20 px-3 py-1 rounded-lg">R$ 0,00</span>
            </button>
        </div>
    </div>

    <!-- [2] MODAL CHECKOUT -->
    <div id="modal-checkout" class="fixed inset-0 bg-black/70 z-50 hidden flex items-end">
        <div class="bg-white w-full max-w-md mx-auto rounded-t-[40px] p-6 space-y-5 max-h-[92vh] overflow-y-auto shadow-2xl">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-xl font-black italic uppercase text-gray-800">Seu Pedido</h2>
                <button onclick="fecharCheckout()" class="text-gray-400 p-2">FECHAR</button>
            </div>

            <!-- Entrega Detalhada -->
            <div class="space-y-3">
                <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Dados de Entrega</p>
                <input id="f-nome" type="text" placeholder="Seu Nome" class="w-full p-4 bg-gray-50 rounded-2xl outline-none focus:ring-1 focus:ring-red-500">
                
                <button id="btn-calc-frete" onclick="obterGPS()" class="w-full bg-gray-900 text-white p-4 rounded-2xl text-[10px] font-black tracking-widest uppercase flex items-center justify-center gap-2">
                    üìç Calcular Frete por Dist√¢ncia
                </button>
                
                <div id="resumo-km" class="hidden bg-green-50 p-4 rounded-2xl flex justify-between items-center border border-green-100">
                    <span id="km-info" class="text-[10px] font-black text-green-700">0.0 KM</span>
                    <span id="taxa-info" class="text-[10px] font-black text-green-700">R$ 0,00</span>
                </div>

                <div class="grid grid-cols-4 gap-2">
                    <input id="f-rua" type="text" placeholder="Rua / Logradouro" class="col-span-3 p-4 bg-gray-50 rounded-2xl outline-none">
                    <input id="f-num" type="text" placeholder="N¬∫" class="col-span-1 p-4 bg-gray-50 rounded-2xl outline-none text-center">
                </div>
                <input id="f-bairro" type="text" placeholder="Bairro" class="w-full p-4 bg-gray-50 rounded-2xl outline-none">
                <input id="f-comp" type="text" placeholder="Complemento / Ponto de Ref" class="w-full p-4 bg-gray-50 rounded-2xl outline-none">
            </div>

            <!-- Pagamento -->
            <div class="space-y-3">
                <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Pagamento</p>
                <select id="f-pag" onchange="toggleTroco(this.value)" class="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none border-none">
                    <option value="Pix">Pix (na entrega)</option>
                    <option value="Cart√£o">Cart√£o (D√©bito/Cr√©dito)</option>
                    <option value="Dinheiro">Dinheiro</option>
                </select>

                <div id="div-troco" class="hidden">
                    <input id="f-troco-valor" type="number" placeholder="Troco para quanto?" oninput="calcTroco()" 
                           class="w-full p-4 bg-orange-50 border-2 border-orange-100 rounded-2xl font-bold outline-none">
                    <p id="msg-troco" class="text-[10px] text-orange-600 font-bold mt-2 text-center"></p>
                </div>
            </div>

            <!-- Totais -->
            <div class="bg-gray-900 text-white p-5 rounded-[30px] space-y-2 shadow-xl">
                <div class="flex justify-between text-[10px] opacity-50 font-black uppercase"><span>Itens:</span><span id="res-itens">R$ 0,00</span></div>
                <div class="flex justify-between text-[10px] opacity-50 font-black uppercase"><span>Frete:</span><span id="res-frete">R$ 0,00</span></div>
                <div class="flex justify-between text-xl font-black pt-2 border-t border-white/10 text-red-500 italic">
                    <span>TOTAL:</span><span id="res-total">R$ 0,00</span>
                </div>
            </div>

            <button onclick="finalizarPedido()" class="w-full bg-green-600 text-white py-5 rounded-[25px] font-black text-sm shadow-xl shadow-green-200 uppercase tracking-widest">Enviar Pedido no WhatsApp</button>
        </div>
    </div>

    <!-- [3] PAINEL ADM -->
    <div id="view-admin" class="hidden bg-white min-h-screen pb-20">
        <header class="bg-black text-white p-6 flex justify-between items-center sticky top-0 z-50">
            <h1 class="font-black italic text-red-600 uppercase">PAINEL ADM</h1>
            <button onclick="location.reload()" class="text-[10px] font-bold border px-4 py-2 rounded-full">SAIR</button>
        </header>

        <div class="p-6 max-w-md mx-auto space-y-6">
            <!-- Configura√ß√µes -->
            <div class="bg-gray-50 p-6 rounded-[35px] space-y-4 shadow-inner">
                <div class="flex justify-between items-center">
                    <span class="text-xs font-bold">Loja Aberta?</span>
                    <label class="switch">
                        <input type="checkbox" id="adm-status-loja" onchange="alterarStatusLoja(this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="text-[9px] font-bold">TAXA BASE (R$)</label>
                        <input id="adm-base" type="number" step="0.01" class="w-full p-3 rounded-xl border-none shadow-sm text-sm">
                    </div>
                    <div>
                        <label class="text-[9px] font-bold">PRE√áO POR KM (R$)</label>
                        <input id="adm-km" type="number" step="0.01" class="w-full p-3 rounded-xl border-none shadow-sm text-sm">
                    </div>
                </div>
                <input id="adm-nome" type="text" placeholder="Nome da Pizzaria" class="w-full p-3 rounded-xl border-none shadow-sm text-sm">
                <input id="adm-zap" type="text" placeholder="WhatsApp 55..." class="w-full p-3 rounded-xl border-none shadow-sm text-sm">
                <input id="adm-logo" type="text" placeholder="Link Logo PNG" class="w-full p-3 rounded-xl border-none shadow-sm text-sm">
                <button onclick="salvarConfigGeral()" class="w-full bg-black text-white p-4 rounded-2xl font-black text-xs">SALVAR TUDO</button>
            </div>
            
            <div id="adm-lista-produtos" class="space-y-4"></div>
        </div>
    </div>

    <!-- [4] CUPOM DE IMPRESS√ÉO -->
    <div id="secao-impressao" class="hidden text-black p-2 font-mono w-[80mm]">
        <center>
            <h2 id="p-loja-nome" class="font-bold text-[16px] uppercase">---</h2>
            <p>================================</p>
        </center>
        <p id="p-data"></p>
        <p id="p-cliente"></p>
        <p id="p-endereco" class="font-bold"></p>
        <p id="p-bairro"></p>
        <p id="p-complemento"></p>
        <p>================================</p>
        <div id="p-lista-itens"></div>
        <p>================================</p>
        <p id="p-subtotal"></p>
        <p id="p-taxa-frete"></p>
        <h3 id="p-total-final" class="font-bold text-[14px]"></h3>
        <p>================================</p>
        <p id="p-metodo-pag"></p>
        <p id="p-info-troco"></p>
        <br><center><p>WWW.MEUDELIVERY.COM</p></center>
    </div>

    <script>
        // CONFIG SUPABASE
        const URL_SB = "https://psqssqfyqqlumdllmosg.supabase.co";
        const KEY_SB = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBzcXNzcWZ5cXFsdW1kbGxtb3NnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMjEwNzMsImV4cCI6MjA4MjY5NzA3M30.fzrGu0P0gSjP3SDoNiM3qnceSKyuMngry42zGqlJRpQ";
        const _sb = supabase.createClient(URL_SB, KEY_SB);

        let PRODUTOS = [], CATEGORIAS = [], CARRINHO = [], CONFIG = {};
        let distanciaKM = 0, taxaEntrega = 0;

        async function init() {
            const { data: c } = await _sb.from('configuracoes').select('*').single();
            CONFIG = c;
            
            // Setup UI Cliente
            document.getElementById('loja-nome').innerText = c.nome_pizzaria;
            document.getElementById('adm-nome').value = c.nome_pizzaria;
            document.getElementById('adm-zap').value = c.whatsapp;
            document.getElementById('adm-logo').value = c.logo_url || "";
            document.getElementById('adm-status-loja').checked = c.loja_aberta;
            document.getElementById('adm-base').value = c.taxa_base;
            document.getElementById('adm-km').value = c.preco_km;

            const status = document.getElementById('loja-status');
            status.innerText = c.loja_aberta ? '‚óè ABERTO AGORA' : '‚óã FECHADO';
            status.className += c.loja_aberta ? ' bg-green-50 text-green-600 border-green-200' : ' bg-gray-50 text-gray-400 border-gray-200';

            if(c.logo_url) {
                document.getElementById('logo-img').src = c.logo_url;
                document.getElementById('logo-img').classList.remove('hidden');
                document.getElementById('logo-placeholder').classList.add('hidden');
            }

            const { data: cats } = await _sb.from('categorias').select('*').order('ordem');
            CATEGORIAS = cats || [];
            renderCategorias();

            const { data: prods } = await _sb.from('produtos').select('*').order('nome');
            PRODUTOS = prods || [];
            renderCardapio('todos');
            renderAdmin();
        }

        // --- C√ÅLCULO DE DIST√ÇNCIA KM ---
        function calcDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
        }

        function obterGPS() {
            const btn = document.getElementById('btn-calc-frete');
            btn.innerText = "‚è≥ LOCALIZANDO...";
            
            navigator.geolocation.getCurrentPosition((pos) => {
                distanciaKM = calcDistancia(
                    Number(CONFIG.lat_pizzaria), Number(CONFIG.lng_pizzaria),
                    pos.coords.latitude, pos.coords.longitude
                );

                taxaEntrega = Number(CONFIG.taxa_base) + (distanciaKM * Number(CONFIG.preco_km));
                
                document.getElementById('resumo-km').classList.remove('hidden');
                document.getElementById('km-info').innerText = `${distanciaKM.toFixed(1)} KM DE DIST√ÇNCIA`;
                document.getElementById('taxa-info').innerText = `FRETE: R$ ${taxaEntrega.toFixed(2)}`;
                
                btn.innerText = "‚úÖ DIST√ÇNCIA CALCULADA";
                btn.className = btn.className.replace('bg-gray-900', 'bg-green-600');
                
                renderTotaisCheckout();
            }, (err) => {
                alert("Ative seu GPS e permita o acesso para calcular o frete!");
                btn.innerText = "üìç Calcular Frete por Dist√¢ncia";
            }, { enableHighAccuracy: true });
        }

        // --- UI RENDER ---
        function renderCategorias() {
            const nav = document.getElementById('filtros');
            nav.innerHTML = `<button onclick="renderCardapio('todos')" class="bg-gray-900 text-white px-6 py-2 rounded-full font-black text-[10px] whitespace-nowrap italic">TODOS</button>`;
            CATEGORIAS.forEach(c => {
                nav.innerHTML += `<button onclick="renderCardapio('${c.id}')" class="bg-white text-gray-500 border border-gray-100 px-6 py-2 rounded-full font-black text-[10px] whitespace-nowrap shadow-sm">${c.nome.toUpperCase()}</button>`;
            });
        }

        function renderCardapio(catId) {
            const div = document.getElementById('cardapio');
            div.innerHTML = "";
            const filtrados = catId === 'todos' ? PRODUTOS : PRODUTOS.filter(p => p.categoria_id === catId);
            
            filtrados.forEach(p => {
                if(!p.disponivel) return;
                div.innerHTML += `
                    <div class="bg-white rounded-[35px] shadow-sm p-4 flex gap-4 items-center border border-gray-50">
                        <div class="w-20 h-20 bg-gray-50 rounded-[25px] overflow-hidden flex-shrink-0">
                            <img src="${p.imagem_url || 'https://cdn-icons-png.flaticon.com/512/3595/3595455.png'}" class="w-full h-full object-contain p-2">
                        </div>
                        <div class="flex-1">
                            <h3 class="font-black text-sm text-gray-800 uppercase italic tracking-tighter">${p.nome}</h3>
                            <p class="text-[9px] text-gray-400 leading-tight mb-2 line-clamp-2">${p.descricao || ''}</p>
                            <div class="flex justify-between items-center">
                                <span class="text-red-600 font-black text-lg italic">R$ ${Number(p.preco).toFixed(2).replace('.', ',')}</span>
                                <button onclick="addToCart('${p.id}')" class="bg-yellow-400 text-black w-10 h-10 rounded-2xl font-black text-xl shadow-lg active:scale-90 transition">+</button>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function addToCart(id) {
            if(!CONFIG.loja_aberta) { alert("Estamos fechados no momento!"); return; }
            const p = PRODUTOS.find(i => i.id === id);
            CARRINHO.push(p);
            const total = CARRINHO.reduce((acc, i) => acc + Number(i.preco), 0);
            document.getElementById('cart-total-btn').innerText = `R$ ${total.toFixed(2).replace('.', ',')}`;
            document.getElementById('cart-fixed').classList.remove('hidden');
        }

        function abrirCheckout() { document.getElementById('modal-checkout').classList.remove('hidden'); renderTotaisCheckout(); }
        function fecharCheckout() { document.getElementById('modal-checkout').classList.add('hidden'); }

        function toggleTroco(val) {
            document.getElementById('div-troco').classList.toggle('hidden', val !== 'Dinheiro');
            calcTroco();
        }

        function renderTotaisCheckout() {
            const sub = CARRINHO.reduce((acc, i) => acc + Number(i.preco), 0);
            const total = sub + taxaEntrega;
            document.getElementById('res-itens').innerText = `R$ ${sub.toFixed(2)}`;
            document.getElementById('res-frete').innerText = `R$ ${taxaEntrega.toFixed(2)}`;
            document.getElementById('res-total').innerText = `R$ ${total.toFixed(2)}`;
            calcTroco();
        }

        function calcTroco() {
            const total = Number(document.getElementById('res-total').innerText.replace('R$ ', ''));
            const pago = Number(document.getElementById('f-troco-valor').value);
            const msg = document.getElementById('msg-troco');
            if(pago > total) msg.innerText = `Levar Troco de R$ ${(pago - total).toFixed(2)}`;
            else msg.innerText = pago > 0 ? "O valor informado √© menor que o total!" : "";
        }

        async function finalizarPedido() {
            if(taxaEntrega === 0) { alert("Por favor, calcule o frete clicando no bot√£o!"); return; }
            const nome = document.getElementById('f-nome').value;
            const rua = document.getElementById('f-rua').value;
            const num = document.getElementById('f-num').value;
            const bairro = document.getElementById('f-bairro').value;
            const comp = document.getElementById('f-comp').value;
            const pag = document.getElementById('f-pag').value;
            const trocoInfo = document.getElementById('msg-troco').innerText;
            const total = document.getElementById('res-total').innerText;

            if(!nome || !rua || !num || !bairro) { alert("Preencha o endere√ßo completo!"); return; }

            // Config Cupom Impress√£o
            document.getElementById('p-loja-nome').innerText = CONFIG.nome_pizzaria;
            document.getElementById('p-data').innerText = `Data: ${new Date().toLocaleString()}`;
            document.getElementById('p-cliente').innerText = `Cliente: ${nome}`;
            document.getElementById('p-endereco').innerText = `End: ${rua}, N¬∫ ${num}`;
            document.getElementById('p-bairro').innerText = `Bairro: ${bairro}`;
            document.getElementById('p-complemento').innerText = `Comp: ${comp}`;
            document.getElementById('p-lista-itens').innerHTML = CARRINHO.map(i => `<div style="display:flex;justify-content:space-between"><span>1x ${i.nome}</span><span>${Number(i.preco).toFixed(2)}</span></div>`).join('');
            document.getElementById('p-subtotal').innerText = `Itens: ${document.getElementById('res-itens').innerText}`;
            document.getElementById('p-taxa-frete').innerText = `Entrega (${distanciaKM.toFixed(1)}km): ${document.getElementById('res-frete').innerText}`;
            document.getElementById('p-total-final').innerText = `TOTAL: ${total}`;
            document.getElementById('p-metodo-pag').innerText = `Pagam: ${pag}`;
            document.getElementById('p-info-troco').innerText = trocoInfo;

            // Enviar WhatsApp
            const itensTxt = CARRINHO.map(i => `üçï *${i.nome}*`).join('%0A');
            const zapLink = `https://wa.me/${CONFIG.whatsapp}?text=*NOVO PEDIDO*%0A%0A*Cliente:* ${nome}%0A*Endere√ßo:* ${rua}, ${num}%0A*Bairro:* ${bairro}%0A*Dist√¢ncia:* ${distanciaKM.toFixed(1)}km%0A%0A*Itens:*%0A${itensTxt}%0A%0A*Pagamento:* ${pag}%0A*${trocoInfo}*%0A*TOTAL: ${total}*`;
            
            window.open(zapLink);
            setTimeout(() => { window.print(); }, 1200);
        }

        // --- ADM LOGIC ---
        function entrarAdmin() {
            if(prompt("Senha do Gerente:") === "123") {
                document.getElementById('view-cliente').classList.add('hidden');
                document.getElementById('view-admin').classList.remove('hidden');
                document.getElementById('cart-fixed').classList.add('hidden');
            }
        }

        async function alterarStatusLoja(val) {
            await _sb.from('configuracoes').update({ loja_aberta: val }).eq('id', 1);
            location.reload();
        }

        async function salvarConfigGeral() {
            const n = document.getElementById('adm-nome').value;
            const z = document.getElementById('adm-zap').value;
            const l = document.getElementById('adm-logo').value;
            const b = document.getElementById('adm-base').value;
            const k = document.getElementById('adm-km').value;
            
            await _sb.from('configuracoes').update({ 
                nome_pizzaria: n, whatsapp: z, logo_url: l, taxa_base: b, preco_km: k 
            }).eq('id', 1);
            alert("Configura√ß√µes atualizadas!");
        }

        function renderAdmin() {
            const div = document.getElementById('adm-lista-produtos');
            div.innerHTML = PRODUTOS.map(p => `
                <div class="bg-gray-100 p-5 rounded-[30px] border border-gray-100 space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="font-black text-[10px] uppercase">${p.nome}</span>
                        <label class="switch">
                            <input type="checkbox" ${p.disponivel ? 'checked' : ''} onchange="toggleDispo('${p.id}', this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="flex gap-2">
                        <input id="img-${p.id}" type="text" value="${p.imagem_url || ''}" class="flex-1 p-3 rounded-xl text-[10px] border-none shadow-inner" placeholder="Link PNG">
                        <input id="prc-${p.id}" type="number" step="0.01" value="${p.preco}" class="w-20 p-3 rounded-xl text-[10px] font-black text-center border-none shadow-inner">
                    </div>
                    <button onclick="saveItem('${p.id}')" class="w-full bg-black text-white py-3 rounded-xl font-bold text-[9px] uppercase tracking-widest">Atualizar Item</button>
                </div>
            `).join('');
        }

        async function toggleDispo(id, val) { await _sb.from('produtos').update({ disponivel: val }).eq('id', id); }
        async function saveItem(id) {
            const p = document.getElementById(`prc-${id}`).value;
            const i = document.getElementById(`img-${id}`).value;
            await _sb.from('produtos').update({ preco: p, imagem_url: i }).eq('id', id);
            alert("Salvo!");
        }

        init();
    </script>
</body>
</html>
