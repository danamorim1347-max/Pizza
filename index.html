<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pizzaria Master | Sistema de Gest√£o</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .hidden { display: none !important; }
        .tab-active { background-color: #ef4444 !important; color: white !important; font-weight: 800; }
        .cat-active { background-color: #000 !important; color: #fff !important; border-color: #000 !important; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        
        /* CORES DE STATUS */
        .status-Novo { background-color: #ef4444; color: white; }
        .status-Preparando { background-color: #f59e0b; color: white; }
        .status-Saiu { background-color: #3b82f6; color: white; }
        .status-Entregue { background-color: #10b981; color: white; }

        @media print {
            body * { visibility: hidden; }
            #secao-impressao, #secao-impressao * { visibility: visible; }
            #secao-impressao { position: absolute; left: 0; top: 0; width: 100%; border: none; background: white !important; }
        }

        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(20px); }
    </style>
</head>
<body>

    <audio id="alerta-som" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <!-- [P√ÅGINA DE RASTREIO CLIENTE] -->
    <div id="view-rastreio" class="hidden max-w-md mx-auto min-h-screen p-6">
        <div class="bg-white p-8 rounded-[40px] shadow-xl text-center border border-gray-100">
            <h2 class="text-2xl font-black italic text-red-600 mb-6 uppercase">Acompanhar Pedido</h2>
            <div id="box-status-cliente" class="py-12 px-4 rounded-3xl border-2 border-dashed mb-6 transition-colors duration-500">
                <p class="text-[10px] font-bold opacity-70 uppercase tracking-widest">Status do seu pedido:</p>
                <h3 id="rastreio-status" class="text-3xl font-black mt-2 italic uppercase">Carregando...</h3>
            </div>
            <button onclick="window.location.reload()" class="w-full bg-black text-white p-5 rounded-2xl font-black uppercase shadow-lg active:scale-95 transition">Atualizar Agora</button>
            <button onclick="window.location.href=window.location.pathname" class="mt-6 text-gray-400 font-bold text-xs uppercase underline">Fazer novo pedido</button>
        </div>
    </div>

    <!-- [VIS√ÉO CLIENTE] -->
    <div id="view-cliente" class="max-w-md mx-auto min-h-screen pb-32">
        <header class="bg-white p-6 rounded-b-[45px] shadow-sm text-center relative border-b">
            <img id="cli-logo" src="" class="h-16 w-16 mx-auto mb-2 object-contain hidden rounded-xl shadow">
            <h1 id="cli-nome" class="text-xl font-black italic uppercase tracking-tighter text-gray-800">PIZZARIA MASTER</h1>
            <div id="cli-status-loja" class="inline-block px-4 py-1 rounded-full text-[9px] font-black mt-2 border uppercase tracking-widest"></div>
            <button onclick="abrirAdmin()" class="absolute top-4 right-4 text-gray-200 text-xl">‚öôÔ∏è</button>
        </header>

        <div class="px-4 mt-6">
            <button onclick="abrirMontador()" class="w-full bg-orange-500 text-white p-5 rounded-[25px] font-black text-xs uppercase shadow-xl flex justify-between items-center active:scale-95 transition">
                <span>üçï Montar Pizza 2 Sabores</span>
                <span class="bg-white/20 px-3 py-1 rounded-lg">MONTAR</span>
            </button>
        </div>

        <nav id="filtros" class="flex gap-2 p-4 overflow-x-auto no-scrollbar sticky top-0 z-20 glass border-b border-gray-50 mt-2"></nav>
        <main id="cardapio" class="p-4 space-y-4"></main>

        <div id="cart-fixed" class="fixed bottom-6 left-0 right-0 px-6 hidden z-30">
            <button onclick="abrirCheckout()" class="max-w-md mx-auto w-full bg-red-600 text-white py-5 rounded-[25px] font-black flex justify-between px-8 shadow-2xl items-center border-b-4 border-red-800 active:scale-95 transition">
                <span>VER SACOLA</span>
                <span id="cart-total-display" class="bg-white/20 px-3 py-1 rounded-lg text-sm">R$ 0,00</span>
            </button>
        </div>
    </div>

    <!-- [MODAL 2 SABORES] -->
    <div id="modal-montador" class="fixed inset-0 bg-black/80 z-50 hidden flex items-end">
        <div class="bg-white w-full max-w-md mx-auto rounded-t-[40px] p-6 space-y-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center"><h2 class="font-black italic uppercase">Meio a Meio</h2><button onclick="fecharMontador()" class="text-2xl">‚úï</button></div>
            <div class="grid grid-cols-2 gap-2">
                <div class="bg-gray-50 p-3 rounded-2xl border"><p class="text-[8px] font-bold text-gray-400 uppercase">Lado 1</p><span id="txt-m1" class="font-bold text-[10px] text-red-600 truncate block">Selecione...</span></div>
                <div class="bg-gray-50 p-3 rounded-2xl border"><p class="text-[8px] font-bold text-gray-400 uppercase">Lado 2</p><span id="txt-m2" class="font-bold text-[10px] text-red-600 truncate block">Selecione...</span></div>
            </div>
            <div id="lista-sabores-montador" class="space-y-2 max-h-60 overflow-y-auto pr-2"></div>
            <button id="btn-confirm-meio" onclick="confirmarMeioAMeio()" class="w-full bg-green-600 text-white py-5 rounded-[25px] font-black uppercase disabled:opacity-30" disabled>Adicionar na Sacola</button>
        </div>
    </div>

    <!-- [MODAL CHECKOUT] -->
    <div id="modal-checkout" class="fixed inset-0 bg-black/70 z-50 hidden flex items-end">
        <div class="bg-white w-full max-w-md mx-auto rounded-t-[40px] p-6 space-y-4 max-h-[94vh] overflow-y-auto shadow-2xl">
            <div class="flex justify-between items-center"><h2 class="font-black italic uppercase">Finalizar</h2><button onclick="fecharCheckout()" class="text-2xl">‚úï</button></div>
            <div id="checkout-itens-list" class="bg-gray-50 p-4 rounded-3xl border space-y-2 text-xs"></div>
            <div class="space-y-3">
                <input id="f-nome" type="text" placeholder="Seu Nome" class="w-full p-4 bg-gray-50 rounded-2xl outline-none border focus:border-red-500">
                <button id="btn-gps-cli" onclick="obterGPSCliente()" class="w-full bg-black text-white p-4 rounded-2xl text-[10px] font-black uppercase tracking-widest flex items-center justify-center gap-2">üìç Calcular Frete por GPS *</button>
                <div id="res-km" class="hidden bg-green-50 p-4 rounded-2xl flex justify-between text-[10px] font-black text-green-700 border border-green-100"><span id="dist-txt">0.0 km</span><span id="taxa-txt">R$ 0,00</span></div>
                <div class="grid grid-cols-4 gap-2">
                    <input id="f-rua" type="text" placeholder="Rua" class="col-span-3 p-4 bg-gray-50 rounded-2xl outline-none border">
                    <input id="f-num" type="text" placeholder="N¬∫" class="col-span-1 p-4 bg-gray-50 rounded-2xl outline-none border text-center">
                </div>
                <input id="f-bairro" type="text" placeholder="Bairro" class="w-full p-4 bg-gray-50 rounded-2xl outline-none border">
                <input id="f-comp" type="text" placeholder="Refer√™ncia (Apto, Bloco, Cor da Casa)" class="w-full p-4 bg-gray-50 rounded-2xl outline-none border">
                <select id="f-pag" onchange="document.getElementById('div-troco').classList.toggle('hidden', this.value!='Dinheiro')" class="w-full p-4 bg-gray-50 rounded-2xl font-bold border">
                    <option value="Pix">Pix</option><option value="Cart√£o">Cart√£o</option><option value="Dinheiro">Dinheiro</option>
                </select>
                <div id="div-troco" class="hidden"><input id="f-troco" type="number" placeholder="Troco para quanto?" class="w-full p-4 bg-orange-50 border-2 border-orange-100 rounded-2xl font-bold"></div>
            </div>
            <div class="bg-gray-900 text-white p-5 rounded-[30px] shadow-xl"><div class="flex justify-between text-2xl font-black text-red-500 italic uppercase"><span>Total:</span><span id="res-total">R$ 0,00</span></div></div>
            <button onclick="enviarPedido()" id="btn-final-zap" class="w-full bg-green-600 text-white py-6 rounded-[25px] font-black uppercase tracking-widest shadow-lg border-b-4 border-green-800">üöÄ ENVIAR PEDIDO</button>
        </div>
    </div>

    <!-- [ADM MASTER] -->
    <div id="view-admin" class="hidden bg-gray-50 min-h-screen pb-20">
        <header class="bg-black text-white p-4 flex justify-between items-center sticky top-0 z-50">
            <h1 class="font-black italic text-red-500 uppercase italic">Painel ADM</h1>
            <button onclick="sairAdmin()" class="text-[10px] font-bold border px-3 py-1 rounded-full uppercase">Sair</button>
        </header>

        <div class="flex bg-white border-b sticky top-14 z-40 overflow-x-auto no-scrollbar shadow-sm">
            <button onclick="switchTab('pedidos')" id="tab-pedidos" class="flex-1 p-4 font-bold text-[10px] uppercase border-b-2 border-transparent">Pedidos</button>
            <button onclick="switchTab('produtos')" id="tab-produtos" class="flex-1 p-4 font-bold text-[10px] uppercase border-b-2 border-transparent">Card√°pio</button>
            <button onclick="switchTab('categorias')" id="tab-categorias" class="flex-1 p-4 font-bold text-[10px] uppercase border-b-2 border-transparent">Categorias</button>
            <button onclick="switchTab('config')" id="tab-config" class="flex-1 p-4 font-bold text-[10px] uppercase border-b-2 border-transparent">Loja/GPS</button>
        </div>

        <div id="adm-content" class="p-4 max-w-md mx-auto space-y-6">
            <div id="sec-pedidos" class="space-y-4"></div>
            <div id="sec-produtos" class="hidden space-y-4"></div>
            <div id="sec-categorias" class="hidden space-y-4"></div>
            <div id="sec-config" class="hidden space-y-4"></div>
        </div>
    </div>

    <!-- [CUPOM DE IMPRESS√ÉO T√âRMICA] -->
    <div id="secao-impressao" class="hidden bg-white text-black font-mono text-[12px] p-4">
        <center>
            <h2 id="p-loja" style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">---</h2>
            <p>===============================</p>
            <p id="p-data"></p>
            <p>===============================</p>
        </center>
        <div style="margin-top: 10px;">
            <p id="p-cliente" style="font-weight: bold; font-size: 14px;"></p>
            <p id="p-endereco"></p>
            <p id="p-bairro"></p>
            <p id="p-comp"></p>
        </div>
        <p>===============================</p>
        <div id="p-itens" style="margin: 10px 0;"></div>
        <p>===============================</p>
        <div style="text-align: right;">
            <p id="p-taxa"></p>
            <h3 id="p-total" style="font-size: 14px; font-weight: bold; margin-top: 5px;"></h3>
        </div>
        <p>===============================</p>
        <p id="p-pag" style="font-weight: bold;"></p>
        <p id="p-troco"></p>
        <br>
        <center><p>WWW.MEUPEDIDO.COM</p></center>
    </div>

    <script>
        const SB_URL = "https://psqssqfyqqlumdllmosg.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBzcXNzcWZ5cXFsdW1kbGxtb3NnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMjEwNzMsImV4cCI6MjA4MjY5NzA3M30.fzrGu0P0gSjP3SDoNiM3qnceSKyuMngry42zGqlJRpQ";
        const _sb = supabase.createClient(SB_URL, SB_KEY);

        let PRODS = [], CATS = [], CARRINHO = [], CONFIG = {}, curCat = 'todos';
        let dKM = 0, tFRETE = 0, latCli = 0, lngCli = 0, gpsOk = false;
        let s1 = null, s2 = null;

        async function init() {
            const params = new URLSearchParams(window.location.search);
            if(params.has('pedido')) return carregarPaginaRastreio(params.get('pedido'));

            const { data: c } = await _sb.from('configuracoes').select('*').single();
            CONFIG = c;
            
            document.getElementById('cli-nome').innerText = c.nome_pizzaria;
            document.getElementById('cli-status-loja').innerText = c.loja_aberta ? '‚óè ABERTO' : '‚óã FECHADO';
            document.getElementById('cli-status-loja').className = c.loja_aberta ? 'inline-block px-4 py-1 rounded-full text-[9px] font-black mt-2 border text-green-600 bg-green-50 uppercase tracking-widest' : 'inline-block px-4 py-1 rounded-full text-[9px] font-black mt-2 border text-gray-400 bg-gray-50 uppercase tracking-widest';
            if(c.logo_url) { document.getElementById('cli-logo').src = c.logo_url; document.getElementById('cli-logo').classList.remove('hidden'); }

            loadMainData();
            
            _sb.channel('db').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'pedidos' }, () => {
                document.getElementById('alerta-som').play();
                if(!document.getElementById('view-admin').classList.contains('hidden')) loadPedidos();
            }).subscribe();
        }

        async function loadMainData() {
            const { data: cats } = await _sb.from('categorias').select('*').order('ordem');
            const { data: prods } = await _sb.from('produtos').select('*').order('nome');
            PRODS = prods || []; CATS = cats || [];
            renderFiltros(); renderCardapio(curCat);
        }

        function renderFiltros() {
            const div = document.getElementById('filtros');
            div.innerHTML = `<button onclick="renderCardapio('todos')" id="btn-todos" class="px-6 py-2 rounded-full font-black text-[10px] italic shadow-md whitespace-nowrap ${curCat === 'todos' ? 'cat-active' : 'bg-white text-gray-400 border'}">TODOS</button>`;
            CATS.forEach(c => {
                div.innerHTML += `<button onclick="renderCardapio('${c.id}')" id="btn-${c.id}" class="bg-white text-gray-400 border px-6 py-2 rounded-full font-black text-[10px] uppercase shadow-sm whitespace-nowrap ${curCat === c.id ? 'cat-active' : 'bg-white text-gray-400 border'}">${c.nome}</button>`;
            });
        }

        function renderCardapio(cid) {
            curCat = cid;
            renderFiltros();
            const div = document.getElementById('cardapio'); div.innerHTML = "";
            const f = cid === 'todos' ? PRODS : PRODS.filter(p => p.categoria_id === cid);
            f.forEach(p => {
                if(!p.disponivel) return;
                div.innerHTML += `<div class="bg-white rounded-[35px] shadow-sm p-4 flex gap-4 border items-center">
                    <img src="${p.imagem_url || ''}" class="w-16 h-16 object-contain rounded-xl">
                    <div class="flex-1">
                        <h3 class="font-black text-xs uppercase italic">${p.nome}</h3>
                        <p class="text-[9px] text-gray-400 line-clamp-1">${p.descricao || ''}</p>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-red-600 font-black">R$ ${Number(p.preco).toFixed(2).replace('.', ',')}</span>
                            <button onclick="addCartSimple('${p.id}')" class="bg-yellow-400 text-black w-9 h-9 rounded-xl font-black text-xl shadow active:scale-90 transition">+</button>
                        </div>
                    </div>
                </div>`;
            });
        }

        function abrirMontador() {
            document.getElementById('modal-montador').classList.remove('hidden');
            const lista = document.getElementById('lista-sabores-montador');
            const pizzas = PRODS.filter(p => p.disponivel && p.categoria_id === CATS.find(c => c.nome.toLowerCase().includes('pizza'))?.id);
            lista.innerHTML = pizzas.map(p => `
                <div class="bg-gray-50 p-4 rounded-2xl border flex justify-between items-center active:bg-red-50 transition" onclick="selecionarMetade('${p.id}', '${p.nome}', ${p.preco}, this)">
                    <span class="font-bold text-[11px] uppercase">${p.nome}</span>
                    <span class="text-red-600 font-black text-[11px]">R$ ${p.preco}</span>
                </div>`).join('');
        }

        function selecionarMetade(id, nome, preco, el) {
            if(!s1) {
                s1 = { nome, preco }; document.getElementById('txt-m1').innerText = nome;
                el.classList.add('border-red-500', 'bg-red-50');
            } else if(!s2) {
                s2 = { nome, preco }; document.getElementById('txt-m2').innerText = nome;
                el.classList.add('border-red-500', 'bg-red-50');
                document.getElementById('btn-confirm-meio').disabled = false;
            } else {
                s1 = { nome, preco }; s2 = null; 
                document.querySelectorAll('#lista-sabores-montador div').forEach(x => x.classList.remove('border-red-500', 'bg-red-50'));
                el.classList.add('border-red-500', 'bg-red-50');
                document.getElementById('txt-m1').innerText = nome;
                document.getElementById('txt-m2').innerText = "Selecione...";
                document.getElementById('btn-confirm-meio').disabled = true;
            }
        }

        function confirmarMeioAMeio() {
            const precoFinal = Math.max(s1.preco, s2.preco);
            CARRINHO.push({ nome: `MEIO A MEIO (1/2 ${s1.nome} + 1/2 ${s2.nome})`, preco: precoFinal });
            updateFooter(); fecharMontador();
        }

        function fecharMontador() { document.getElementById('modal-montador').classList.add('hidden'); s1 = null; s2 = null; document.getElementById('btn-confirm-meio').disabled = true; }

        function addCartSimple(id) {
            if(!CONFIG.loja_aberta) return alert("Loja fechada!");
            CARRINHO.push(PRODS.find(p => p.id === id));
            updateFooter();
        }

        function updateFooter() {
            const total = CARRINHO.reduce((a, b) => a + Number(b.preco), 0);
            document.getElementById('cart-total-display').innerText = `R$ ${total.toFixed(2).replace('.', ',')}`;
            document.getElementById('cart-fixed').classList.remove('hidden');
        }

        function agruparItens(lista) {
            return lista.reduce((acc, item) => {
                acc[item.nome] = (acc[item.nome] || 0) + 1;
                return acc;
            }, {});
        }

        function abrirCheckout() {
            document.getElementById('modal-checkout').classList.remove('hidden');
            document.getElementById('f-nome').value = localStorage.getItem('p_nome') || "";
            document.getElementById('f-rua').value = localStorage.getItem('p_rua') || "";
            document.getElementById('f-num').value = localStorage.getItem('p_num') || "";
            document.getElementById('f-bairro').value = localStorage.getItem('p_bairro') || "";
            document.getElementById('f-comp').value = localStorage.getItem('p_comp') || "";
            
            const listDiv = document.getElementById('checkout-itens-list');
            const agrupados = agruparItens(CARRINHO);
            listDiv.innerHTML = Object.entries(agrupados).map(([nome, qtd]) => `
                <div class="flex justify-between font-bold border-b border-gray-100 pb-1"><span>${qtd}x ${nome}</span></div>
            `).join('');
            
            const sub = CARRINHO.reduce((a, b) => a + Number(b.preco), 0);
            document.getElementById('res-total').innerText = `R$ ${(sub + tFRETE).toFixed(2).replace('.', ',')}`;
        }

        function fecharCheckout() { document.getElementById('modal-checkout').classList.add('hidden'); }

        function obterGPSCliente() {
            const btn = document.getElementById('btn-gps-cli'); btn.innerText = "‚è≥ LOCALIZANDO...";
            navigator.geolocation.getCurrentPosition(pos => {
                latCli = pos.coords.latitude; lngCli = pos.coords.longitude;
                const lat1 = Number(CONFIG.lat_pizzaria), lon1 = Number(CONFIG.lng_pizzaria);
                const R = 6371; const dLat = (latCli-lat1)*Math.PI/180; const dLon = (lngCli-lon1)*Math.PI/180;
                const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(latCli*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
                dKM = R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
                tFRETE = Number(CONFIG.taxa_base) + (dKM * Number(CONFIG.preco_km));
                document.getElementById('res-km').classList.remove('hidden');
                document.getElementById('dist-txt').innerText = `${dKM.toFixed(1)} km`;
                document.getElementById('taxa-txt').innerText = `R$ ${tFRETE.toFixed(2)}`;
                btn.innerText = "‚úÖ FRETE CALCULADO"; btn.className = "w-full bg-green-600 text-white p-4 rounded-2xl text-[10px] font-black uppercase";
                gpsOk = true;
                const sub = CARRINHO.reduce((a, b) => a + Number(b.preco), 0);
                document.getElementById('res-total').innerText = `R$ ${(sub + tFRETE).toFixed(2).replace('.', ',')}`;
            });
        }

        async function enviarPedido() {
            const n = document.getElementById('f-nome').value, r = document.getElementById('f-rua').value, num = document.getElementById('f-num').value;
            const b = document.getElementById('f-bairro').value, comp = document.getElementById('f-comp').value, pag = document.getElementById('f-pag').value;
            const totalStr = document.getElementById('res-total').innerText;
            const troco = document.getElementById('f-troco').value || "N√£o precisa";

            if(!gpsOk) return alert("C√°lculo de frete via GPS √© obrigat√≥rio!");
            if(!n || !r || !num) return alert("Preencha seu endere√ßo!");

            localStorage.setItem('p_nome', n); localStorage.setItem('p_rua', r); localStorage.setItem('p_num', num); localStorage.setItem('p_bairro', b); localStorage.setItem('p_comp', comp);

            const { data: ped } = await _sb.from('pedidos').insert([{
                cliente_nome: n, rua: r, numero: num, bairro: b, complemento: comp, 
                distancia_km: dKM, taxa_entrega: tFRETE, total: Number(totalStr.replace('R$ ', '').replace(',','.')), 
                pagamento: pag, troco: troco, lat_cliente: latCli.toString(), lng_cliente: lngCli.toString()
            }]).select();

            if(ped) {
                await _sb.from('itens_pedido').insert(CARRINHO.map(i => ({ pedido_id: ped[0].id, produto_nome: i.nome, preco: i.preco })));
                const agrupados = agruparItens(CARRINHO);
                let itensTxt = "";
                for (const [nome, qtd] of Object.entries(agrupados)) { itensTxt += `‚Ä¢ ${qtd}x *${nome}*\n`; }

                const urlRastreio = `${window.location.origin}${window.location.pathname}?pedido=${ped[0].id}`;
                const msg = `*NOVO PEDIDO*\n------------------\n*Cliente:* ${n}\n*End:* ${r}, ${num} - ${b}\n*Ref:* ${comp}\n------------------\n*Itens:*\n${itensTxt}\n------------------\n*TOTAL:* ${totalStr}\n*Pag:* ${pag}\n*Troco:* ${troco}\n\nüìç *Localiza√ß√£o:*\nhttps://www.google.com/maps?q=${latCli},${lngCli}\n\nüõ∞Ô∏è *Acompanhe seu pedido:*\n${urlRastreio}`;

                window.open(`https://api.whatsapp.com/send?phone=${CONFIG.whatsapp.replace(/\D/g, '')}&text=${encodeURIComponent(msg)}`);
                window.location.href = urlRastreio;
            }
        }

        async function carregarPaginaRastreio(id) {
            document.getElementById('view-cliente').classList.add('hidden');
            document.getElementById('view-rastreio').classList.remove('hidden');
            const { data } = await _sb.from('pedidos').select('status').eq('id', id).single();
            const status = data ? data.status : "---";
            document.getElementById('rastreio-status').innerText = status.toUpperCase();
            document.getElementById('box-status-cliente').className = `py-12 px-4 rounded-3xl border-2 border-dashed mb-6 transition-colors duration-500 status-${status.replace(/ /g, '')}`;
        }

        // --- ADM ---
        function abrirAdmin() { if(prompt("Senha:") === "123") { document.getElementById('view-cliente').classList.add('hidden'); document.getElementById('view-admin').classList.remove('hidden'); switchTab('pedidos'); } }
        function sairAdmin() { location.reload(); }

        async function switchTab(t) {
            ['pedidos', 'produtos', 'categorias', 'config'].forEach(tab => {
                document.getElementById(`sec-${tab}`).classList.toggle('hidden', tab !== t);
                const btn = document.getElementById(`tab-${tab}`);
                if(tab === t) btn.classList.add('tab-active'); else btn.classList.remove('tab-active');
            });
            if(t === 'pedidos') loadPedidos();
            if(t === 'produtos') loadAdmProds();
            if(t === 'categorias') loadAdmCats();
            if(t === 'config') loadAdmConfig();
        }

        async function loadPedidos() {
            const { data } = await _sb.from('pedidos').select('*, itens_pedido(*)').order('created_at', { ascending: false }).limit(15);
            const div = document.getElementById('sec-pedidos');
            div.innerHTML = `<h2 class="text-[10px] font-black text-gray-400 uppercase mb-4 tracking-widest">Controle de Cozinha</h2>`;
            data.forEach(p => {
                const agrupados = agruparItens(p.itens_pedido.map(it => ({ nome: it.produto_nome })));
                div.innerHTML += `
                    <div class="bg-white p-5 rounded-3xl shadow-sm border-l-8 status-${p.status.replace(/ /g, '')} mb-4">
                        <div class="flex justify-between font-black text-[10px] mb-2"><span class="text-black">${p.cliente_nome}</span><span class="bg-white/30 px-2 rounded">${p.status}</span></div>
                        <div class="text-[9px] text-gray-500 mb-2">${p.rua}, ${p.numero} - ${p.bairro}</div>
                        <div class="text-[9px] font-bold border-y py-2 mb-2 italic text-gray-700">${Object.entries(agrupados).map(([nome, qtd]) => `${qtd}x ${nome}`).join(', ')}</div>
                        <div class="flex justify-between items-center mt-3">
                            <span class="font-black text-sm text-gray-900">R$ ${p.total.toFixed(2)}</span>
                            <div class="flex gap-2">
                                <button onclick="imprimirPedido('${p.id}')" class="bg-gray-100 p-2 rounded-lg text-lg">üñ®Ô∏è</button>
                                <select onchange="updateStatus('${p.id}', this.value)" class="text-[9px] bg-black text-white p-2 rounded-lg font-bold">
                                    <option value="">A√ß√£o</option><option value="Preparando">No Forno</option><option value="Saiu">Saiu para Entrega</option><option value="Entregue">Entregue</option>
                                </select>
                            </div>
                        </div>
                    </div>`;
            });
        }

        async function imprimirPedido(id) {
            const { data: p } = await _sb.from('pedidos').select('*, itens_pedido(*)').eq('id', id).single();
            if(!p) return;
            
            document.getElementById('p-loja').innerText = CONFIG.nome_pizzaria;
            document.getElementById('p-data').innerText = `DATA: ${new Date(p.created_at).toLocaleString('pt-BR')}`;
            document.getElementById('p-cliente').innerText = `CLIENTE: ${p.cliente_nome}`;
            document.getElementById('p-endereco').innerText = `END: ${p.rua}, ${p.numero}`;
            document.getElementById('p-bairro').innerText = `BAIRRO: ${p.bairro}`;
            document.getElementById('p-comp').innerText = `REF: ${p.complemento || '---'}`;
            
            const agrupados = agruparItens(p.itens_pedido.map(it => ({ nome: it.produto_nome })));
            document.getElementById('p-itens').innerHTML = Object.entries(agrupados).map(([nome, qtd]) => `
                <div style="display:flex;justify-content:space-between"><span>${qtd}x ${nome}</span></div>`).join('');
            
            document.getElementById('p-taxa').innerText = `TAXA: R$ ${p.taxa_entrega.toFixed(2)}`;
            document.getElementById('p-total').innerText = `TOTAL: R$ ${p.total.toFixed(2)}`;
            document.getElementById('p-pag').innerText = `PAGAM: ${p.pagamento}`;
            document.getElementById('p-troco').innerText = `TROCO: ${p.troco}`;
            
            setTimeout(() => { window.print(); }, 500);
        }

        async function updateStatus(id, s) { await _sb.from('pedidos').update({ status: s }).eq('id', id); loadPedidos(); }
        async function obterGPSLoja() { navigator.geolocation.getCurrentPosition(async pos => { await _sb.from('configuracoes').update({ lat_pizzaria: pos.coords.latitude, lng_pizzaria: pos.coords.longitude }).eq('id', 1); alert("Localiza√ß√£o Salva!"); location.reload(); }); }
        
        function loadAdmProds() {
            const div = document.getElementById('sec-produtos');
            div.innerHTML = `<div class="bg-white p-5 rounded-3xl shadow-sm border border-red-100 mb-6"><h3 class="font-black text-xs text-red-600 uppercase mb-3">‚ûï Novo Produto</h3><input id="add-n" type="text" placeholder="Nome" class="w-full p-3 bg-gray-50 border rounded-xl mb-2 text-sm"><input id="add-d" type="text" placeholder="Descri√ß√£o" class="w-full p-3 bg-gray-50 border rounded-xl mb-2 text-sm"><div class="flex gap-2 mb-2"><input id="add-p" type="number" placeholder="Pre√ßo" class="flex-1 p-3 bg-gray-50 border rounded-xl text-sm"><select id="add-c" class="flex-1 p-3 bg-gray-50 border rounded-xl text-sm">${CATS.map(c=>`<option value="${c.id}">${c.nome}</option>`).join('')}</select></div><input id="add-i" type="text" placeholder="Link Imagem PNG" class="w-full p-3 bg-gray-50 border rounded-xl mb-3 text-sm"><button onclick="criarProd()" class="w-full bg-red-600 text-white py-4 rounded-2xl font-black text-xs uppercase shadow-lg">Cadastrar no Card√°pio</button></div>`;
            PRODS.forEach(p => {
                div.innerHTML += `<div class="bg-white p-5 rounded-3xl shadow-sm border mb-4">
                    <div class="flex justify-between items-center"><span class="font-bold text-[11px] uppercase text-gray-800">${p.nome}</span><label class="switch"><input type="checkbox" ${p.disponivel ? 'checked' : ''} onchange="toggleProd('${p.id}', this.checked)"><span class="slider"></span></label></div>
                    <input id="img-${p.id}" type="text" value="${p.imagem_url || ''}" class="w-full p-2 bg-gray-50 border rounded-lg text-[10px] my-3" placeholder="Link PNG">
                    <div class="flex gap-2 mb-3"><select id="cat-${p.id}" class="flex-1 p-2 bg-gray-50 border rounded-lg text-[10px] font-bold">${CATS.map(c=>`<option value="${c.id}" ${p.categoria_id===c.id?'selected':''}>${c.nome}</option>`).join('')}</select><input id="prc-${p.id}" type="number" step="0.01" value="${p.preco}" class="w-20 p-2 border rounded-lg text-center font-black text-[10px]"></div>
                    <button onclick="salvarProdADM('${p.id}')" class="w-full bg-black text-white py-3 rounded-xl font-bold text-[10px] uppercase">Salvar Altera√ß√µes</button>
                </div>`;
            });
        }
        async function criarProd() { await _sb.from('produtos').insert([{ nome: document.getElementById('add-n').value, descricao: document.getElementById('add-d').value, preco: document.getElementById('add-p').value, categoria_id: document.getElementById('add-c').value, imagem_url: document.getElementById('add-i').value }]); await loadMainData(); loadAdmProds(); }
        async function salvarProdADM(id) { await _sb.from('produtos').update({ preco: document.getElementById(`prc-${id}`).value, categoria_id: document.getElementById(`cat-${id}`).value, imagem_url: document.getElementById(`img-${id}`).value }).eq('id', id); alert("OK!"); await loadMainData(); loadAdmProds(); }
        
        function loadAdmCats() {
            const div = document.getElementById('sec-categorias');
            div.innerHTML = `<div class="bg-white p-5 rounded-3xl shadow-sm border mb-6"><h3 class="font-black text-xs uppercase mb-3">‚ûï Nova Categoria</h3><input id="new-cat" type="text" placeholder="Nome da Categoria" class="w-full p-3 bg-gray-50 border rounded-xl mb-3 text-sm"><button onclick="criarCat()" class="w-full bg-green-600 text-white py-4 rounded-xl font-black text-xs uppercase shadow-md">Adicionar</button></div>`;
            CATS.forEach(c => div.innerHTML += `<div class="bg-white p-4 rounded-2xl border flex justify-between items-center mb-2"><span class="font-bold text-xs uppercase text-gray-700">${c.nome}</span><button onclick="deletarCat('${c.id}')" class="text-red-500 font-bold text-[10px] bg-red-50 px-3 py-1 rounded-full">REMOVER</button></div>`);
        }
        async function criarCat() { await _sb.from('categorias').insert([{ nome: document.getElementById('new-cat').value, ordem: CATS.length }]); await loadMainData(); loadAdmCats(); }
        async function deletarCat(id) { if(confirm("Deseja apagar?")) { await _sb.from('categorias').delete().eq('id', id); await loadMainData(); loadAdmCats(); } }

        function loadAdmConfig() {
            const div = document.getElementById('sec-config');
            div.innerHTML = `<div class="bg-white p-6 rounded-[35px] shadow-sm space-y-5">
                <button onclick="obterGPSLoja()" class="w-full ${CONFIG.lat_pizzaria ? 'bg-green-600' : 'bg-red-500'} text-white p-4 rounded-2xl text-[10px] font-black uppercase shadow-lg">üìç Definir GPS da Loja</button>
                <div class="flex justify-between items-center p-4 bg-gray-50 rounded-2xl border"><span class="font-black text-[10px] uppercase italic">Loja Aberta?</span><label class="switch"><input type="checkbox" onchange="toggleLoja(this.checked)" ${CONFIG.loja_aberta?'checked':''}><span class="slider"></span></label></div>
                <div class="space-y-2">
                    <p class="text-[9px] font-black text-gray-400 uppercase tracking-widest">Informa√ß√µes B√°sicas</p>
                    <input id="adm-n" type="text" value="${CONFIG.nome_pizzaria}" class="w-full p-4 bg-gray-50 border-none rounded-xl text-sm font-bold shadow-inner">
                    <input id="adm-z" type="text" value="${CONFIG.whatsapp}" class="w-full p-4 bg-gray-50 border-none rounded-xl text-sm shadow-inner">
                </div>
                <div class="flex gap-2">
                    <div class="flex-1"><p class="text-[8px] font-bold text-gray-400">TAXA BASE</p><input id="adm-b" type="number" value="${CONFIG.taxa_base}" class="w-full p-3 bg-gray-50 border-none rounded-xl text-sm shadow-inner"></div>
                    <div class="flex-1"><p class="text-[8px] font-bold text-gray-400">VALOR/KM</p><input id="adm-k" type="number" value="${CONFIG.preco_km}" class="w-full p-3 bg-gray-50 border-none rounded-xl text-sm shadow-inner"></div>
                </div>
                <input id="adm-l" type="text" value="${CONFIG.logo_url || ''}" class="w-full p-3 border rounded-xl text-xs" placeholder="URL Logo PNG">
                <button onclick="salvarConfig()" class="w-full bg-black text-white p-5 rounded-[25px] font-black text-xs uppercase shadow-xl">Salvar Tudo</button>
            </div>`;
        }

        async function toggleLoja(v) { await _sb.from('configuracoes').update({ loja_aberta: v }).eq('id', 1); CONFIG.loja_aberta = v; }
        async function toggleProd(id, v) { await _sb.from('produtos').update({ disponivel: v }).eq('id', id); }
        async function salvarConfig() { await _sb.from('configuracoes').update({ nome_pizzaria: document.getElementById('adm-n').value, whatsapp: document.getElementById('adm-z').value, taxa_base: document.getElementById('adm-b').value, preco_km: document.getElementById('adm-k').value, logo_url: document.getElementById('adm-l').value }).eq('id', 1); alert("Salvo!"); init(); }

        init();
    </script>
</body>
</html>
