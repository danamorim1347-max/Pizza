<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizzaria Pro | Sistema de Pedidos</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .hidden { display: none !important; }
        .tab-active { border-bottom: 3px solid #ef4444; color: #ef4444; font-weight: bold; }
        
        /* Animações */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        
        /* Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px; width: 18px;
            left: 4px; bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(24px); }
    </style>
</head>
<body class="bg-gray-50">
    
    <!-- Áudio de notificação -->
    <audio id="alerta-som" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <!-- VISÃO CLIENTE -->
    <div id="view-cliente">
        <!-- Header -->
        <div class="bg-white shadow-sm">
            <div class="max-w-md mx-auto p-6 text-center">
                <h1 id="cli-nome" class="text-2xl font-bold text-gray-900">Pizzaria Pro</h1>
                <div id="cli-status" class="inline-block mt-2 px-4 py-1 rounded-full text-sm font-bold"></div>
            </div>
            
            <!-- Filtros -->
            <div id="filtros" class="px-4 pb-4 flex gap-2 overflow-x-auto"></div>
        </div>
        
        <!-- Cardápio -->
        <div id="cardapio" class="max-w-md mx-auto p-4 space-y-4"></div>
        
        <!-- Carrinho -->
        <div id="cart-fixed" class="fixed bottom-0 left-0 right-0 p-4 bg-white border-t shadow-lg hidden">
            <button onclick="abrirCheckout()" class="w-full bg-red-600 text-white py-4 rounded-xl font-bold text-lg flex justify-between items-center px-6">
                <span>FINALIZAR PEDIDO</span>
                <span id="cart-total-display" class="bg-white/20 px-3 py-1 rounded-lg">R$ 0,00</span>
            </button>
        </div>
        
        <!-- Botão Admin -->
        <button onclick="abrirAdmin()" class="fixed top-4 right-4 bg-gray-800 text-white p-3 rounded-full">
            <i class="fas fa-cog"></i>
        </button>
    </div>

    <!-- MODAL CHECKOUT -->
    <div id="modal-checkout" class="fixed inset-0 bg-black/80 z-50 hidden items-end">
        <div class="bg-white w-full max-w-md mx-auto rounded-t-2xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Finalizar Pedido</h2>
                <button onclick="fecharCheckout()" class="text-gray-500 text-2xl">&times;</button>
            </div>
            
            <!-- Alerta localização -->
            <div id="alerta-localizacao" class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-4 hidden">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                    <span class="text-yellow-800 font-medium">É obrigatório calcular o frete!</span>
                </div>
            </div>
            
            <!-- Formulário -->
            <div class="space-y-4">
                <input id="f-nome" type="text" placeholder="Seu nome completo *" class="w-full p-4 border rounded-xl" required>
                
                <button id="btn-gps-cli" onclick="obterGPSCliente()" class="w-full bg-black text-white p-4 rounded-xl font-bold flex items-center justify-center gap-2">
                    <i class="fas fa-map-marker-alt"></i> CALCULAR FRETE (OBRIGATÓRIO)
                </button>
                
                <div id="res-km" class="bg-green-50 border border-green-200 rounded-xl p-4 hidden">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-bold text-green-800" id="dist-txt">0.0 km</div>
                            <div class="text-sm text-green-600">Distância calculada</div>
                        </div>
                        <div class="font-bold text-xl text-green-800" id="taxa-txt">R$ 0,00</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-2">
                    <input id="f-rua" type="text" placeholder="Rua *" class="col-span-2 p-4 border rounded-xl" required>
                    <input id="f-num" type="text" placeholder="Nº *" class="p-4 border rounded-xl text-center" required>
                </div>
                
                <input id="f-bairro" type="text" placeholder="Bairro *" class="w-full p-4 border rounded-xl" required>
                <input id="f-comp" type="text" placeholder="Complemento" class="w-full p-4 border rounded-xl">
                
                <select id="f-pag" class="w-full p-4 border rounded-xl" onchange="document.getElementById('div-troco').classList.toggle('hidden', this.value!='Dinheiro')">
                    <option value="Pix">Pix</option>
                    <option value="Cartão">Cartão</option>
                    <option value="Dinheiro">Dinheiro</option>
                </select>
                
                <div id="div-troco" class="hidden">
                    <input id="f-troco" type="number" placeholder="Troco para quanto?" class="w-full p-4 border rounded-xl">
                </div>
                
                <!-- Total -->
                <div class="bg-gray-900 text-white p-5 rounded-xl">
                    <div class="flex justify-between text-2xl font-bold">
                        <span>TOTAL:</span>
                        <span id="res-total">R$ 0,00</span>
                    </div>
                </div>
                
                <button onclick="enviarPedido()" id="btn-enviar" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold text-lg">
                    <i class="fab fa-whatsapp mr-2"></i> ENVIAR PEDIDO
                </button>
            </div>
        </div>
    </div>

    <!-- PAINEL ADMIN -->
    <div id="view-admin" class="hidden min-h-screen bg-gray-100">
        <!-- Header Admin -->
        <div class="bg-black text-white p-4">
            <div class="max-w-md mx-auto flex justify-between items-center">
                <h1 class="text-xl font-bold"><i class="fas fa-crown mr-2"></i> PAINEL ADMIN</h1>
                <div class="flex gap-2">
                    <button onclick="voltarParaCliente()" class="px-3 py-1 border rounded-lg text-sm">
                        <i class="fas fa-store mr-1"></i> Loja
                    </button>
                    <button onclick="sairAdmin()" class="px-3 py-1 border rounded-lg text-sm">
                        <i class="fas fa-sign-out-alt mr-1"></i> Sair
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="bg-white border-b">
            <div class="max-w-md mx-auto flex">
                <button onclick="switchTab('pedidos')" id="tab-pedidos" class="flex-1 py-4 font-bold tab-active">PEDIDOS</button>
                <button onclick="switchTab('produtos')" id="tab-produtos" class="flex-1 py-4 font-bold">CARDÁPIO</button>
                <button onclick="switchTab('config')" id="tab-config" class="flex-1 py-4 font-bold">CONFIG</button>
            </div>
        </div>
        
        <!-- Conteúdo -->
        <div class="max-w-md mx-auto p-4">
            
            <!-- ABA PEDIDOS -->
            <div id="sec-pedidos">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-lg">Pedidos Recebidos</h2>
                    <button onclick="loadPedidos()" class="text-gray-600">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
                <div id="lista-pedidos" class="space-y-4">
                    <div class="text-center py-8">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-red-500"></div>
                        <p class="text-gray-500 mt-2">Carregando pedidos...</p>
                    </div>
                </div>
            </div>
            
            <!-- ABA PRODUTOS -->
            <div id="sec-produtos" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-lg">Gerenciar Produtos</h2>
                    <button onclick="abrirModalProduto()" class="bg-red-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-plus mr-1"></i> Novo
                    </button>
                </div>
                <div id="lista-produtos" class="space-y-3">
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-pizza-slice text-3xl mb-2"></i>
                        <p>Carregando produtos...</p>
                    </div>
                </div>
            </div>
            
            <!-- ABA CONFIG -->
            <div id="sec-config" class="hidden space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <!-- Status Loja -->
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <div class="font-bold">Loja Aberta?</div>
                            <div class="text-sm text-gray-500">Clientes podem fazer pedidos</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="adm-check-loja" onchange="alterarStatusLoja(this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <!-- Localização -->
                    <div class="mb-6">
                        <div class="font-bold mb-2">Localização da Loja</div>
                        <button id="btn-gps-loja" onclick="obterGPSLoja()" class="w-full bg-blue-600 text-white p-3 rounded-lg mb-2">
                            <i class="fas fa-map-marker-alt mr-2"></i> Definir Localização
                        </button>
                        <div class="text-center text-sm text-gray-600">
                            <span id="txt-lat">0</span>, <span id="txt-lng">0</span>
                        </div>
                    </div>
                    
                    <!-- Configurações -->
                    <div class="space-y-4">
                        <input id="adm-nome" type="text" placeholder="Nome da Pizzaria" class="w-full p-3 border rounded-lg">
                        <input id="adm-zap" type="text" placeholder="WhatsApp (5511999999999)" class="w-full p-3 border rounded-lg">
                        <div class="grid grid-cols-2 gap-3">
                            <input id="adm-base" type="number" placeholder="Taxa Base" class="p-3 border rounded-lg">
                            <input id="adm-km" type="number" placeholder="Preço por KM" class="p-3 border rounded-lg">
                        </div>
                        <button onclick="salvarConfig()" class="w-full bg-black text-white p-3 rounded-lg font-bold">
                            SALVAR CONFIGURAÇÕES
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PRODUTO -->
    <div id="modal-produto" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <!-- Conteúdo será injetado aqui -->
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURAÇÃO INICIAL
        // ============================================
        const SB_URL = "https://psqssqfyqqlumdllmosg.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBzcXNzcWZ5cXFsdW1kbGxtb3NnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMjEwNzMsImV4cCI6MjA4MjY5NzA3M30.fzrGu0P0gSjP3SDoNiM3qnceSKyuMngry42zGqlJRpQ";
        
        const supabase = supabase.createClient(SB_URL, SB_KEY);
        
        // Variáveis globais
        let produtos = [];
        let categorias = [];
        let carrinho = [];
        let config = {};
        let distancia = 0;
        let frete = 0;
        let latCliente = 0;
        let lngCliente = 0;
        let isAdmin = localStorage.getItem('isAdmin') === 'true';
        
        // ============================================
        // INICIALIZAÇÃO
        // ============================================
        document.addEventListener('DOMContentLoaded', init);
        
        async function init() {
            console.log('Iniciando sistema...');
            
            try {
                // Carregar configurações
                await carregarConfiguracoes();
                
                // Carregar dados iniciais
                await carregarDadosIniciais();
                
                // Configurar estado inicial
                if (isAdmin && localStorage.getItem('adminView') === 'true') {
                    mostrarPainelAdmin();
                }
                
                // Configurar realtime
                configurarRealtime();
                
            } catch (error) {
                console.error('Erro na inicialização:', error);
                alert('Erro ao carregar o sistema. Recarregue a página.');
            }
        }
        
        async function carregarConfiguracoes() {
            try {
                console.log('Carregando configurações...');
                const { data, error } = await supabase
                    .from('configuracoes')
                    .select('*')
                    .single();
                    
                if (error) {
                    console.log('Criando configurações padrão...');
                    // Criar configuração padrão
                    const { data: novaConfig } = await supabase
                        .from('configuracoes')
                        .insert([{
                            nome_pizzaria: 'Minha Pizzaria',
                            whatsapp: '5511999999999',
                            taxa_base: 5,
                            preco_km: 2,
                            loja_aberta: true
                        }])
                        .select()
                        .single();
                        
                    config = novaConfig;
                } else {
                    config = data;
                }
                
                console.log('Configurações carregadas:', config);
                atualizarUIComConfig();
                
            } catch (error) {
                console.error('Erro ao carregar configurações:', error);
                throw error;
            }
        }
        
        async function carregarDadosIniciais() {
            try {
                console.log('Carregando produtos e categorias...');
                
                // Carregar categorias
                const { data: cats, error: errorCats } = await supabase
                    .from('categorias')
                    .select('*')
                    .order('ordem');
                    
                if (!errorCats) categorias = cats || [];
                
                // Carregar produtos
                const { data: prods, error: errorProds } = await supabase
                    .from('produtos')
                    .select('*')
                    .order('nome');
                    
                if (!errorProds) produtos = prods || [];
                
                console.log(`Carregados: ${categorias.length} categorias, ${produtos.length} produtos`);
                
                // Renderizar cardápio
                renderizarFiltros();
                renderizarCardapio('todos');
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                throw error;
            }
        }
        
        function atualizarUIComConfig() {
            // Atualizar nome da loja
            document.getElementById('cli-nome').textContent = config.nome_pizzaria || 'Pizzaria';
            
            // Atualizar status
            const statusEl = document.getElementById('cli-status');
            if (config.loja_aberta) {
                statusEl.textContent = '● ABERTO';
                statusEl.className = 'inline-block mt-2 px-4 py-1 rounded-full text-sm font-bold text-green-600 bg-green-50';
            } else {
                statusEl.textContent = '○ FECHADO';
                statusEl.className = 'inline-block mt-2 px-4 py-1 rounded-full text-sm font-bold text-gray-400 bg-gray-50';
            }
            
            // Atualizar painel admin
            if (document.getElementById('adm-check-loja')) {
                document.getElementById('adm-check-loja').checked = config.loja_aberta;
                document.getElementById('adm-nome').value = config.nome_pizzaria || '';
                document.getElementById('adm-zap').value = config.whatsapp || '';
                document.getElementById('adm-base').value = config.taxa_base || 0;
                document.getElementById('adm-km').value = config.preco_km || 0;
                document.getElementById('txt-lat').textContent = config.lat_pizzaria || '0';
                document.getElementById('txt-lng').textContent = config.lng_pizzaria || '0';
            }
        }
        
        // ============================================
        // FUNÇÕES DO CARDÁPIO
        // ============================================
        function renderizarFiltros() {
            const container = document.getElementById('filtros');
            if (!container) return;
            
            container.innerHTML = `
                <button onclick="renderizarCardapio('todos')" class="px-4 py-2 bg-black text-white rounded-full font-bold whitespace-nowrap">
                    TODOS
                </button>
            `;
            
            categorias.forEach(categoria => {
                container.innerHTML += `
                    <button onclick="renderizarCardapio('${categoria.id}')" class="px-4 py-2 bg-white border rounded-full font-bold whitespace-nowrap">
                        ${categoria.nome}
                    </button>
                `;
            });
        }
        
        function renderizarCardapio(categoriaId) {
            const container = document.getElementById('cardapio');
            if (!container) return;
            
            // Filtrar produtos
            let produtosFiltrados = [];
            if (categoriaId === 'todos') {
                produtosFiltrados = produtos.filter(p => p.disponivel !== false);
            } else {
                produtosFiltrados = produtos.filter(p => 
                    p.categoria_id === categoriaId && p.disponivel !== false
                );
            }
            
            // Se não houver produtos
            if (produtosFiltrados.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-pizza-slice text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500">Nenhum produto disponível</p>
                    </div>
                `;
                return;
            }
            
            // Renderizar produtos
            container.innerHTML = '';
            produtosFiltrados.forEach(produto => {
                container.innerHTML += `
                    <div class="bg-white rounded-xl p-4 shadow-sm fade-in">
                        <div class="flex items-start gap-4">
                            <img src="${produto.imagem_url || 'https://via.placeholder.com/80x80/EDF2F7/4B5563?text=PIZZA'}" 
                                 alt="${produto.nome}"
                                 class="w-20 h-20 object-cover rounded-lg">
                            <div class="flex-1">
                                <h3 class="font-bold text-lg">${produto.nome}</h3>
                                ${produto.descricao ? `<p class="text-gray-600 text-sm mt-1">${produto.descricao}</p>` : ''}
                                <div class="flex justify-between items-center mt-3">
                                    <span class="font-bold text-red-600 text-xl">R$ ${Number(produto.preco).toFixed(2)}</span>
                                    <button onclick="adicionarAoCarrinho('${produto.id}')" 
                                            class="bg-yellow-500 text-white w-10 h-10 rounded-lg font-bold text-xl"
                                            ${!config.loja_aberta ? 'disabled style="opacity:0.5"' : ''}>
                                        +
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        function adicionarAoCarrinho(produtoId) {
            if (!config.loja_aberta) {
                alert('A loja está fechada no momento.');
                return;
            }
            
            const produto = produtos.find(p => p.id === produtoId);
            if (!produto) return;
            
            carrinho.push(produto);
            
            // Atualizar total do carrinho
            const total = carrinho.reduce((soma, item) => soma + Number(item.preco), 0);
            document.getElementById('cart-total-display').textContent = `R$ ${total.toFixed(2)}`;
            
            // Mostrar carrinho
            document.getElementById('cart-fixed').classList.remove('hidden');
            
            // Feedback visual
            const botao = event.target;
            botao.style.transform = 'scale(1.2)';
            setTimeout(() => {
                botao.style.transform = 'scale(1)';
            }, 200);
        }
        
        // ============================================
        // CHECKOUT E WHATSAPP
        // ============================================
        function abrirCheckout() {
            if (carrinho.length === 0) {
                alert('Seu carrinho está vazio!');
                return;
            }
            
            if (!config.loja_aberta) {
                alert('A loja está fechada no momento.');
                return;
            }
            
            document.getElementById('modal-checkout').classList.remove('hidden');
            calcularTotalCheckout();
        }
        
        function fecharCheckout() {
            document.getElementById('modal-checkout').classList.add('hidden');
        }
        
        function calcularTotalCheckout() {
            const subtotal = carrinho.reduce((soma, item) => soma + Number(item.preco), 0);
            const total = subtotal + frete;
            document.getElementById('res-total').textContent = `R$ ${total.toFixed(2)}`;
        }
        
        function obterGPSCliente() {
            if (!config.lat_pizzaria || !config.lng_pizzaria) {
                alert('Configure a localização da loja no painel administrativo primeiro.');
                return;
            }
            
            const botao = document.getElementById('btn-gps-cli');
            botao.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> CALCULANDO...';
            botao.disabled = true;
            
            if (!navigator.geolocation) {
                alert('Seu navegador não suporta geolocalização.');
                botao.innerHTML = '<i class="fas fa-map-marker-alt mr-2"></i> CALCULAR FRETE';
                botao.disabled = false;
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                async (pos) => {
                    latCliente = pos.coords.latitude;
                    lngCliente = pos.coords.longitude;
                    
                    // Calcular distância
                    distancia = calcularDistancia(
                        config.lat_pizzaria,
                        config.lng_pizzaria,
                        latCliente,
                        lngCliente
                    );
                    
                    // Calcular frete
                    frete = (config.taxa_base || 0) + (distancia * (config.preco_km || 0));
                    
                    // Atualizar UI
                    document.getElementById('res-km').classList.remove('hidden');
                    document.getElementById('dist-txt').textContent = `${distancia.toFixed(1)} km`;
                    document.getElementById('taxa-txt').textContent = `R$ ${frete.toFixed(2)}`;
                    
                    botao.innerHTML = '<i class="fas fa-check mr-2"></i> FRETE CALCULADO';
                    botao.classList.remove('bg-black');
                    botao.classList.add('bg-green-600');
                    
                    calcularTotalCheckout();
                    
                },
                (error) => {
                    console.error('Erro de geolocalização:', error);
                    alert('Não foi possível obter sua localização. Permita o acesso à localização no seu navegador.');
                    botao.innerHTML = '<i class="fas fa-map-marker-alt mr-2"></i> CALCULAR FRETE';
                    botao.disabled = false;
                }
            );
        }
        
        function calcularDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
        }
        
        async function enviarPedido() {
            // Validações
            const nome = document.getElementById('f-nome').value.trim();
            const rua = document.getElementById('f-rua').value.trim();
            const numero = document.getElementById('f-num').value.trim();
            const bairro = document.getElementById('f-bairro').value.trim();
            const complemento = document.getElementById('f-comp').value.trim();
            const pagamento = document.getElementById('f-pag').value;
            const troco = document.getElementById('f-troco').value || "Não precisa";
            
            if (!nome || !rua || !numero || !bairro) {
                alert('Preencha todos os campos obrigatórios.');
                return;
            }
            
            if (!latCliente || frete === 0) {
                document.getElementById('alerta-localizacao').classList.remove('hidden');
                alert('Calcule o frete antes de enviar o pedido!');
                return;
            }
            
            if (carrinho.length === 0) {
                alert('Seu carrinho está vazio.');
                return;
            }
            
            try {
                // Calcular total
                const subtotal = carrinho.reduce((soma, item) => soma + Number(item.preco), 0);
                const total = subtotal + frete;
                
                // Desabilitar botão
                const botaoEnviar = document.getElementById('btn-enviar');
                botaoEnviar.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> ENVIANDO...';
                botaoEnviar.disabled = true;
                
                // Salvar no banco
                const { data: pedido, error: pedidoError } = await supabase
                    .from('pedidos')
                    .insert([{
                        cliente_nome: nome,
                        rua: rua,
                        numero: numero,
                        bairro: bairro,
                        complemento: complemento,
                        distancia_km: parseFloat(distancia.toFixed(1)),
                        taxa_entrega: parseFloat(frete.toFixed(2)),
                        total: parseFloat(total.toFixed(2)),
                        pagamento: pagamento,
                        troco: troco,
                        status: 'Novo'
                    }])
                    .select()
                    .single();
                    
                if (pedidoError) throw pedidoError;
                
                // Salvar itens
                const itens = carrinho.map(item => ({
                    pedido_id: pedido.id,
                    produto_nome: item.nome,
                    preco: item.preco,
                    produto_id: item.id
                }));
                
                const { error: itensError } = await supabase
                    .from('itens_pedido')
                    .insert(itens);
                    
                if (itensError) throw itensError;
                
                // Preparar WhatsApp
                let telefone = (config.whatsapp || '5511999999999')
                    .toString()
                    .replace(/\D/g, '');
                
                let mensagem = `*NOVO PEDIDO - ${config.nome_pizzaria}*%0A%0A`;
                mensagem += `*Cliente:* ${nome}%0A`;
                mensagem += `*Endereço:* ${rua}, ${numero}%0A`;
                mensagem += `*Bairro:* ${bairro}%0A`;
                if (complemento) mensagem += `*Referência:* ${complemento}%0A`;
                mensagem += `%0A*Itens:*%0A`;
                
                carrinho.forEach(item => {
                    mensagem += `• ${item.nome} - R$ ${Number(item.preco).toFixed(2)}%0A`;
                });
                
                mensagem += `%0A*Distância:* ${distancia.toFixed(1)} km%0A`;
                mensagem += `*Frete:* R$ ${frete.toFixed(2)}%0A`;
                mensagem += `*Subtotal:* R$ ${subtotal.toFixed(2)}%0A`;
                mensagem += `*TOTAL:* R$ ${total.toFixed(2)}%0A%0A`;
                mensagem += `*Pagamento:* ${pagamento}%0A`;
                if (pagamento === 'Dinheiro') {
                    mensagem += `*Troco para:* R$ ${troco}%0A`;
                }
                mensagem += `%0A*Localização:*%0A`;
                mensagem += `https://maps.google.com/?q=${latCliente},${lngCliente}`;
                
                const urlWhatsapp = `https://wa.me/${telefone}?text=${encodeURIComponent(mensagem)}`;
                
                // Abrir WhatsApp
                window.open(urlWhatsapp, '_blank');
                
                // Limpar e recarregar
                carrinho = [];
                alert('Pedido enviado com sucesso!');
                setTimeout(() => location.reload(), 1000);
                
            } catch (error) {
                console.error('Erro ao enviar pedido:', error);
                alert('Erro ao enviar pedido. Tente novamente.');
                
                // Reabilitar botão
                const botaoEnviar = document.getElementById('btn-enviar');
                botaoEnviar.innerHTML = '<i class="fab fa-whatsapp mr-2"></i> ENVIAR PEDIDO';
                botaoEnviar.disabled = false;
            }
        }
        
        // ============================================
        // PAINEL ADMINISTRATIVO
        // ============================================
        function abrirAdmin() {
            const senha = prompt('Digite a senha de administrador:');
            if (senha === '123') {
                isAdmin = true;
                localStorage.setItem('isAdmin', 'true');
                localStorage.setItem('adminView', 'true');
                mostrarPainelAdmin();
            } else if (senha !== null) {
                alert('Senha incorreta!');
            }
        }
        
        function mostrarPainelAdmin() {
            document.getElementById('view-cliente').classList.add('hidden');
            document.getElementById('view-admin').classList.remove('hidden');
            switchTab('pedidos');
        }
        
        function sairAdmin() {
            isAdmin = false;
            localStorage.removeItem('isAdmin');
            localStorage.removeItem('adminView');
            voltarParaCliente();
        }
        
        function voltarParaCliente() {
            document.getElementById('view-admin').classList.add('hidden');
            document.getElementById('view-cliente').classList.remove('hidden');
        }
        
        function switchTab(aba) {
            ['pedidos', 'produtos', 'config'].forEach(tab => {
                document.getElementById(`sec-${tab}`).classList.toggle('hidden', tab !== aba);
                document.getElementById(`tab-${tab}`).classList.toggle('tab-active', tab === aba);
            });
            
            if (aba === 'pedidos') {
                loadPedidos();
            } else if (aba === 'produtos') {
                renderizarProdutosAdmin();
            }
        }
        
        async function loadPedidos() {
            const container = document.getElementById('lista-pedidos');
            container.innerHTML = `
                <div class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-red-500"></div>
                    <p class="text-gray-500 mt-2">Carregando pedidos...</p>
                </div>
            `;
            
            try {
                const { data: pedidos, error } = await supabase
                    .from('pedidos')
                    .select(`
                        *,
                        itens_pedido (*)
                    `)
                    .order('created_at', { ascending: false })
                    .limit(20);
                    
                if (error) throw error;
                
                if (!pedidos || pedidos.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-shopping-cart text-4xl text-gray-300 mb-3"></i>
                            <p class="text-gray-500">Nenhum pedido encontrado</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                pedidos.forEach(pedido => {
                    const data = new Date(pedido.created_at).toLocaleString('pt-BR');
                    const itens = pedido.itens_pedido?.map(i => i.produto_nome).join(', ') || 'Sem itens';
                    
                    container.innerHTML += `
                        <div class="bg-white rounded-xl p-4 shadow-sm">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h3 class="font-bold">${pedido.cliente_nome}</h3>
                                    <p class="text-sm text-gray-500">${data}</p>
                                </div>
                                <span class="px-3 py-1 rounded-full text-sm font-bold ${
                                    pedido.status === 'Novo' ? 'bg-red-100 text-red-700' :
                                    pedido.status === 'Preparando' ? 'bg-yellow-100 text-yellow-700' :
                                    pedido.status === 'Saiu para entrega' ? 'bg-blue-100 text-blue-700' :
                                    'bg-green-100 text-green-700'
                                }">
                                    ${pedido.status}
                                </span>
                            </div>
                            
                            <p class="text-sm text-gray-600 mb-2">
                                ${pedido.rua}, ${pedido.numero} - ${pedido.bairro}
                            </p>
                            
                            <p class="text-sm mb-3">${itens}</p>
                            
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="font-bold text-lg">R$ ${pedido.total.toFixed(2)}</div>
                                    <div class="text-sm text-gray-500">Frete: R$ ${pedido.taxa_entrega.toFixed(2)}</div>
                                </div>
                                
                                <select onchange="atualizarStatusPedido('${pedido.id}', this.value)" 
                                        class="px-3 py-1 border rounded-lg">
                                    <option value="">Status</option>
                                    <option ${pedido.status === 'Novo' ? 'selected' : ''}>Novo</option>
                                    <option ${pedido.status === 'Preparando' ? 'selected' : ''}>Preparando</option>
                                    <option ${pedido.status === 'Saiu para entrega' ? 'selected' : ''}>Saiu para entrega</option>
                                    <option ${pedido.status === 'Entregue' ? 'selected' : ''}>Entregue</option>
                                </select>
                            </div>
                        </div>
                    `;
                });
                
            } catch (error) {
                console.error('Erro ao carregar pedidos:', error);
                container.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        Erro ao carregar pedidos
                    </div>
                `;
            }
        }
        
        async function atualizarStatusPedido(id, status) {
            if (!status) return;
            
            try {
                await supabase
                    .from('pedidos')
                    .update({ status })
                    .eq('id', id);
                    
                loadPedidos();
            } catch (error) {
                console.error('Erro ao atualizar status:', error);
                alert('Erro ao atualizar status');
            }
        }
        
        function renderizarProdutosAdmin() {
            const container = document.getElementById('lista-produtos');
            container.innerHTML = '';
            
            produtos.forEach(produto => {
                container.innerHTML += `
                    <div class="bg-white p-4 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="font-bold">${produto.nome}</h4>
                                <p class="text-red-600 font-bold">R$ ${Number(produto.preco).toFixed(2)}</p>
                            </div>
                            <button onclick="editarProduto('${produto.id}')" class="text-gray-500 hover:text-black">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
        }
        
        async function obterGPSLoja() {
            const botao = document.getElementById('btn-gps-loja');
            botao.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> OBTENDO...';
            botao.disabled = true;
            
            if (!navigator.geolocation) {
                alert('Seu navegador não suporta geolocalização.');
                botao.innerHTML = '<i class="fas fa-map-marker-alt mr-2"></i> Definir Localização';
                botao.disabled = false;
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                async (pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    
                    try {
                        await supabase
                            .from('configuracoes')
                            .update({ 
                                lat_pizzaria: lat, 
                                lng_pizzaria: lng 
                            })
                            .eq('id', config.id);
                            
                        config.lat_pizzaria = lat;
                        config.lng_pizzaria = lng;
                        
                        document.getElementById('txt-lat').textContent = lat.toFixed(6);
                        document.getElementById('txt-lng').textContent = lng.toFixed(6);
                        
                        alert('Localização salva com sucesso!');
                        
                    } catch (error) {
                        console.error('Erro ao salvar localização:', error);
                        alert('Erro ao salvar localização');
                    }
                    
                    botao.innerHTML = '<i class="fas fa-map-marker-alt mr-2"></i> Definir Localização';
                    botao.disabled = false;
                },
                (error) => {
                    console.error('Erro de geolocalização:', error);
                    alert('Não foi possível obter a localização.');
                    botao.innerHTML = '<i class="fas fa-map-marker-alt mr-2"></i> Definir Localização';
                    botao.disabled = false;
                }
            );
        }
        
        async function alterarStatusLoja(aberta) {
            try {
                await supabase
                    .from('configuracoes')
                    .update({ loja_aberta: aberta })
                    .eq('id', config.id);
                    
                config.loja_aberta = aberta;
                atualizarUIComConfig();
                alert(`Loja ${aberta ? 'aberta' : 'fechada'} com sucesso!`);
            } catch (error) {
                console.error('Erro ao alterar status:', error);
                alert('Erro ao alterar status da loja');
            }
        }
        
        async function salvarConfig() {
            const nome = document.getElementById('adm-nome').value.trim();
            const whatsapp = document.getElementById('adm-zap').value.trim();
            const taxaBase = parseFloat(document.getElementById('adm-base').value) || 0;
            const precoKm = parseFloat(document.getElementById('adm-km').value) || 0;
            
            if (!nome || !whatsapp) {
                alert('Preencha nome e WhatsApp');
                return;
            }
            
            try {
                await supabase
                    .from('configuracoes')
                    .update({
                        nome_pizzaria: nome,
                        whatsapp: whatsapp,
                        taxa_base: taxaBase,
                        preco_km: precoKm
                    })
                    .eq('id', config.id);
                    
                config.nome_pizzaria = nome;
                config.whatsapp = whatsapp;
                config.taxa_base = taxaBase;
                config.preco_km = precoKm;
                
                atualizarUIComConfig();
                alert('Configurações salvas!');
                
            } catch (error) {
                console.error('Erro ao salvar configurações:', error);
                alert('Erro ao salvar configurações');
            }
        }
        
        // ============================================
        // REALTIME
        // ============================================
        function configurarRealtime() {
            // Escutar novos pedidos
            supabase
                .channel('pedidos-realtime')
                .on('postgres_changes', 
                    { event: 'INSERT', schema: 'public', table: 'pedidos' },
                    () => {
                        // Tocar som
                        document.getElementById('alerta-som').play().catch(console.log);
                        
                        // Se estiver na aba pedidos, atualizar
                        if (!document.getElementById('sec-pedidos').classList.contains('hidden')) {
                            loadPedidos();
                        }
                    }
                )
                .subscribe();
        }
        
        // ============================================
        // EXPOR FUNÇÕES PARA HTML
        // ============================================
        window.abrirAdmin = abrirAdmin;
        window.voltarParaCliente = voltarParaCliente;
        window.sairAdmin = sairAdmin;
        window.fecharCheckout = fecharCheckout;
        window.abrirCheckout = abrirCheckout;
        window.obterGPSCliente = obterGPSCliente;
        window.enviarPedido = enviarPedido;
        window.loadPedidos = loadPedidos;
        window.switchTab = switchTab;
        window.renderizarCardapio = renderizarCardapio;
        window.adicionarAoCarrinho = adicionarAoCarrinho;
        window.obterGPSLoja = obterGPSLoja;
        window.alterarStatusLoja = alterarStatusLoja;
        window.salvarConfig = salvarConfig;
        window.atualizarStatusPedido = atualizarStatusPedido;
        
    </script>
</body>
</html>
