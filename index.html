<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Web App Pizzaria | Sistema Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; }
        .hidden { display: none !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* STATUS COLORS */
        .status-Novo { border-left: 8px solid #ef4444; background: #fef2f2; }
        .status-Preparando { border-left: 8px solid #f59e0b; background: #fffbeb; }
        .status-Pronto { border-left: 8px solid #a855f7; background: #faf5ff; }
        .status-Saiu { border-left: 8px solid #3b82f6; background: #eff6ff; }
        .status-Finalizado { border-left: 8px solid #10b981; background: #f0fdf4; opacity: 0.7; }
        
        .tab-active { background: #ef4444 !important; color: white !important; font-weight: 800; }
        
        @media print {
            body * { visibility: hidden; }
            #secao-impressao, #secao-impressao * { visibility: visible; }
            #secao-impressao { position: absolute; left: 0; top: 0; width: 100%; border: none; }
        }
    </style>
</head>
<body>

    <audio id="alerta-som" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <!-- [P√ÅGINA RASTREIO] -->
    <div id="view-rastreio" class="hidden max-w-md mx-auto min-h-screen p-6 text-center">
        <div class="bg-white p-8 rounded-[40px] shadow-xl border">
            <h2 class="text-2xl font-black italic text-red-600 mb-4">Status do Pedido</h2>
            <div id="rastreio-box" class="py-10 rounded-3xl border-4 border-double mb-6">
                <h3 id="rastreio-status" class="text-3xl font-black uppercase italic">---</h3>
            </div>
            <button onclick="window.location.reload()" class="w-full bg-black text-white p-5 rounded-2xl font-black">ATUALIZAR</button>
            <button onclick="window.location.href=window.location.pathname" class="mt-4 text-xs font-bold uppercase text-gray-400">Voltar ao Card√°pio</button>
        </div>
    </div>

    <!-- [P√ÅGINA CLIENTE] -->
    <div id="view-cliente" class="max-w-md mx-auto min-h-screen pb-32">
        <header class="bg-white p-6 rounded-b-[40px] shadow-sm text-center relative">
            <h1 id="cli-nome-loja" class="text-xl font-black italic uppercase tracking-tighter">CARREGANDO...</h1>
            <div id="cli-status-loja" class="inline-block px-4 py-1 rounded-full text-[9px] font-black mt-2 border uppercase"></div>
            <button onclick="abrirAdmin()" class="absolute top-4 right-4 text-gray-200">‚öôÔ∏è</button>
        </header>

        <div class="px-4 mt-4">
            <button onclick="abrirMeio()" class="w-full bg-orange-500 text-white p-4 rounded-3xl font-black text-xs uppercase shadow-lg shadow-orange-100 flex justify-between items-center">
                <span>üçï Pizza 2 Sabores</span>
                <span class="bg-white/20 px-2 rounded">MONTAR</span>
            </button>
        </div>

        <nav id="filtros" class="flex gap-2 p-4 overflow-x-auto no-scrollbar sticky top-0 z-20 bg-white/80 backdrop-blur-sm"></nav>
        <main id="cardapio" class="p-4 space-y-4"></main>

        <div id="cart-fixed" class="fixed bottom-6 left-0 right-0 px-6 hidden z-30">
            <button onclick="abrirCheckout()" class="max-w-md mx-auto w-full bg-red-600 text-white py-5 rounded-[25px] font-black flex justify-between px-8 shadow-2xl border-b-4 border-red-800">
                <span>REVISAR PEDIDO</span>
                <span id="total-flutuante" class="bg-white/20 px-3 py-1 rounded-lg">R$ 0,00</span>
            </button>
        </div>
    </div>

    <!-- [MODAL CHECKOUT] -->
    <div id="modal-checkout" class="fixed inset-0 bg-black/80 z-50 hidden flex items-end">
        <div class="bg-white w-full max-w-md mx-auto rounded-t-[40px] p-6 space-y-4 max-h-[92vh] overflow-y-auto">
            <div class="flex justify-between items-center"><h2 class="font-black italic uppercase">Checkout</h2><button onclick="fecharCheckout()">‚úï</button></div>
            
            <div class="grid grid-cols-3 gap-2 p-1 bg-gray-100 rounded-2xl">
                <button onclick="setModo('delivery')" id="m-delivery" class="p-3 text-[9px] font-black rounded-xl bg-white shadow-sm">DELIVERY</button>
                <button onclick="setModo('retirada')" id="m-retirada" class="p-3 text-[9px] font-black rounded-xl text-gray-400">RETIRADA</button>
                <button onclick="setModo('local')" id="m-local" class="p-3 text-[9px] font-black rounded-xl text-gray-400">NO LOCAL</button>
            </div>

            <div id="checkout-itens" class="bg-gray-50 p-4 rounded-3xl border text-xs space-y-1"></div>

            <div class="space-y-3">
                <input id="f-nome" type="text" placeholder="Nome" class="w-full p-4 bg-gray-50 rounded-2xl border outline-none">
                <div id="area-endereco" class="space-y-3">
                    <button id="btn-gps" onclick="obterGPS()" class="w-full bg-black text-white p-4 rounded-2xl text-[10px] font-black uppercase">üìç Localizar por GPS *</button>
                    <div id="res-gps" class="hidden bg-green-50 p-3 rounded-xl flex justify-between text-[10px] font-black text-green-700">
                        <span id="txt-dist">0 km</span><span id="txt-taxa">R$ 0,00</span>
                    </div>
                    <div class="grid grid-cols-4 gap-2">
                        <input id="f-rua" type="text" placeholder="Rua" class="col-span-3 p-4 bg-gray-50 rounded-2xl border outline-none">
                        <input id="f-num" type="text" placeholder="N¬∫" class="col-span-1 p-4 bg-gray-50 rounded-2xl border outline-none text-center">
                    </div>
                    <input id="f-bairro" type="text" placeholder="Bairro" class="w-full p-4 bg-gray-50 rounded-2xl border outline-none">
                </div>
                <input id="f-comp" type="text" placeholder="Complemento / Refer√™ncia" class="w-full p-4 bg-gray-50 rounded-2xl border outline-none">
                <select id="f-pag" onchange="document.getElementById('div-troco').classList.toggle('hidden', this.value!='Dinheiro')" class="w-full p-4 bg-gray-50 rounded-2xl font-bold border">
                    <option value="Pix">Pix</option><option value="Cart√£o">Cart√£o</option><option value="Dinheiro">Dinheiro</option>
                </select>
                <div id="div-troco" class="hidden"><input id="f-troco" type="number" placeholder="Troco para quanto?" class="w-full p-4 bg-orange-50 border-2 border-orange-100 rounded-2xl font-bold"></div>
            </div>

            <div class="bg-gray-900 text-white p-5 rounded-[30px]"><div class="flex justify-between text-2xl font-black text-red-500 italic uppercase"><span>Total:</span><span id="res-total">R$ 0,00</span></div></div>
            <button onclick="enviarPedido()" class="w-full bg-green-600 text-white py-6 rounded-[25px] font-black uppercase tracking-widest border-b-4 border-green-800">üöÄ ENVIAR PEDIDO</button>
        </div>
    </div>

    <!-- [PAINEL ADM] -->
    <div id="view-admin" class="hidden bg-gray-50 min-h-screen pb-20">
        <header class="bg-black text-white p-4 flex justify-between items-center sticky top-0 z-50">
            <h1 class="font-black italic text-red-500 uppercase">GEST√ÉO ADM</h1>
            <button onclick="location.reload()" class="text-[10px] font-bold border px-3 py-1 rounded-full uppercase">Sair</button>
        </header>
        <div class="flex bg-white border-b sticky top-14 z-40 shadow-sm">
            <button onclick="switchTab('pedidos')" id="tab-pedidos" class="flex-1 p-4 font-bold text-[10px] tab-active uppercase">Pedidos</button>
            <button onclick="switchTab('produtos')" id="tab-produtos" class="flex-1 p-4 font-bold text-[10px] uppercase">Card√°pio</button>
            <button onclick="switchTab('config')" id="tab-config" class="flex-1 p-4 font-bold text-[10px] uppercase">GPS/Loja</button>
        </div>
        <div id="adm-content" class="p-4 max-w-md mx-auto space-y-4">
            <div id="sec-pedidos" class="space-y-4"></div>
            <div id="sec-produtos" class="hidden space-y-4"></div>
            <div id="sec-config" class="hidden space-y-4"></div>
        </div>
    </div>

    <!-- [CUPOM IMPRESS√ÉO] -->
    <div id="secao-impressao" class="hidden font-mono text-[12px] leading-tight text-black p-4">
        <center><h2 id="p-loja" class="font-bold text-[16px]">---</h2><p>===============================</p></center>
        <p id="p-tipo" class="font-black text-center text-sm"></p>
        <p id="p-data"></p><p id="p-cliente" class="font-bold"></p><p id="p-endereco"></p>
        <p>===============================</p><div id="p-itens"></div><p>===============================</p>
        <p id="p-taxa"></p><h3 id="p-total" class="font-bold text-[14px]"></h3><p id="p-pag"></p><p id="p-troco"></p>
    </div>

    <script>
        const SB_URL = "https://psqssqfyqqlumdllmosg.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBzcXNzcWZ5cXFsdW1kbGxtb3NnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMjEwNzMsImV4cCI6MjA4MjY5NzA3M30.fzrGu0P0gSjP3SDoNiM3qnceSKyuMngry42zGqlJRpQ";
        const _sb = supabase.createClient(SB_URL, SB_KEY);

        let PRODS = [], CATS = [], CARRINHO = [], CONFIG = {}, curCat = 'todos';
        let dKM = 0, tFRETE = 0, latCli = 0, lngCli = 0, gpsOk = false, modo = 'delivery';

        async function init() {
            const params = new URLSearchParams(window.location.search);
            if(params.has('pedido')) return loadRastreio(params.get('pedido'));

            const { data: c } = await _sb.from('configuracoes').select('*').single();
            CONFIG = c;
            
            document.getElementById('cli-nome-loja').innerText = c.nome_pizzaria;
            document.getElementById('cli-status-loja').innerText = c.loja_aberta ? '‚óè ABERTO' : '‚óã FECHADO';
            document.getElementById('cli-status-loja').className += c.loja_aberta ? ' text-green-600 bg-green-50' : ' text-gray-400 bg-gray-50';

            loadData();
            _sb.channel('db').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'pedidos' }, () => {
                document.getElementById('alerta-som').play();
                if(!document.getElementById('view-admin').classList.contains('hidden')) loadPedidos();
            }).subscribe();
        }

        async function loadData() {
            const { data: cats } = await _sb.from('categorias').select('*').order('ordem');
            const { data: prods } = await _sb.from('produtos').select('*').order('nome');
            PRODS = prods || []; CATS = cats || [];
            renderFiltros(); renderCardapio('todos');
        }

        function renderFiltros() {
            const div = document.getElementById('filtros');
            div.innerHTML = `<button onclick="renderCardapio('todos')" class="bg-black text-white px-6 py-2 rounded-full font-black text-[10px] italic shadow-sm">TODOS</button>`;
            CATS.forEach(c => div.innerHTML += `<button onclick="renderCardapio('${c.id}')" class="bg-white text-gray-400 border px-6 py-2 rounded-full font-black text-[10px] uppercase shadow-sm">${c.nome}</button>`);
        }

        function renderCardapio(cid) {
            const div = document.getElementById('cardapio'); div.innerHTML = "";
            const f = cid === 'todos' ? PRODS : PRODS.filter(p => p.categoria_id === cid);
            f.forEach(p => {
                if(!p.disponivel) return;
                div.innerHTML += `<div class="bg-white rounded-[35px] shadow-sm p-4 flex gap-4 border border-gray-50 items-center">
                    <img src="${p.imagem_url || ''}" class="w-14 h-14 object-contain rounded-xl">
                    <div class="flex-1">
                        <h3 class="font-black text-[11px] uppercase italic text-gray-800">${p.nome}</h3>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-red-600 font-black">R$ ${Number(p.preco).toFixed(2).replace('.', ',')}</span>
                            <button onclick="addCart('${p.id}')" class="bg-yellow-400 text-black w-8 h-8 rounded-xl font-black text-xl shadow active:scale-90 transition">+</button>
                        </div>
                    </div>
                </div>`;
            });
        }

        function addCart(id) {
            if(!CONFIG.loja_aberta) return alert("Loja fechada!");
            const p = PRODUTOS.find(i => i.id === id);
            CARRINHO.push(p);
            const total = CARRINHO.reduce((a, b) => a + Number(b.preco), 0);
            document.getElementById('total-flutuante').innerText = `R$ ${total.toFixed(2).replace('.', ',')}`;
            document.getElementById('cart-fixed').classList.remove('hidden');
        }

        function setModo(m) {
            modo = m;
            ['delivery', 'retirada', 'local'].forEach(x => {
                const btn = document.getElementById(`m-${x}`);
                btn.className = x === m ? "p-3 text-[9px] font-black rounded-xl bg-white shadow-sm border text-black" : "p-3 text-[9px] font-black rounded-xl text-gray-400";
            });
            document.getElementById('area-endereco').classList.toggle('hidden', m !== 'delivery');
            if(m !== 'delivery') { tFRETE = 0; gpsOk = true; } else { gpsOk = false; }
            renderCheckoutTotal();
        }

        function obterGPS() {
            navigator.geolocation.getCurrentPosition(pos => {
                latCli = pos.coords.latitude; lngCli = pos.coords.longitude;
                const lat1 = Number(CONFIG.lat_pizzaria), lon1 = Number(CONFIG.lng_pizzaria);
                const R = 6371; const dLat = (latCli-lat1)*Math.PI/180; const dLon = (lngCli-lon1)*Math.PI/180;
                const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(latCli*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
                dKM = R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
                tFRETE = Number(CONFIG.taxa_base) + (dKM * Number(CONFIG.preco_km));
                document.getElementById('res-gps').classList.remove('hidden');
                document.getElementById('txt-dist').innerText = `${dKM.toFixed(1)} km`;
                document.getElementById('txt-taxa').innerText = `R$ ${tFRETE.toFixed(2)}`;
                gpsOk = true; renderCheckoutTotal();
            });
        }

        function renderCheckoutTotal() {
            const sub = CARRINHO.reduce((a, b) => a + Number(b.preco), 0);
            document.getElementById('res-total').innerText = `R$ ${(sub + tFRETE).toFixed(2).replace('.', ',')}`;
        }

        async function enviarPedido() {
            const n = document.getElementById('f-nome').value, r = document.getElementById('f-rua').value, num = document.getElementById('f-num').value;
            const b = document.getElementById('f-bairro').value, totalStr = document.getElementById('res-total').innerText;
            if(!gpsOk && modo === 'delivery') return alert("GPS obrigat√≥rio!");
            if(!n) return alert("Digite seu nome!");

            const { data: ped } = await _sb.from('pedidos').insert([{
                cliente_nome: n, rua: modo === 'delivery' ? r : modo.toUpperCase(), numero: num, bairro: b, 
                distancia_km: dKM, taxa_entrega: tFRETE, total: Number(totalStr.replace('R$ ', '').replace(',','.')), 
                pagamento: document.getElementById('f-pag').value, troco: document.getElementById('f-troco').value || "N√£o",
                lat_cliente: latCli.toString(), lng_cliente: lngCli.toString()
            }]).select();

            if(ped) {
                await _sb.from('itens_pedido').insert(CARRINHO.map(i => ({ pedido_id: ped[0].id, produto_nome: i.nome, preco: i.preco })));
                const agrupados = agrupar(CARRINHO);
                let itensTxt = "";
                for (const [nome, qtd] of Object.entries(agrupados)) { itensTxt += `‚Ä¢ ${qtd}x *${nome}*\n`; }
                const url = `${window.location.origin}${window.location.pathname}?pedido=${ped[0].id}`;
                const msg = `*NOVO PEDIDO: ${modo.toUpperCase()}*\n*Cliente:* ${n}\n*Itens:*\n${itensTxt}\n*TOTAL:* ${totalStr}\nüõ∞Ô∏è *Rastreio:* ${url}`;
                window.open(`https://api.whatsapp.com/send?phone=${CONFIG.whatsapp.replace(/\D/g, '')}&text=${encodeURIComponent(msg)}`);
                window.location.href = url;
            }
        }

        async function loadPedidos() {
            const { data } = await _sb.from('pedidos').select('*, itens_pedido(*)').order('created_at', { ascending: false }).limit(20);
            const div = document.getElementById('sec-pedidos');
            div.innerHTML = `<h2 class="text-[10px] font-black text-gray-400 uppercase mb-4 tracking-widest">Painel Cozinha</h2>`;
            data.forEach(p => {
                const ag = agrupar(p.itens_pedido.map(i => ({ nome: i.produto_nome })));
                div.innerHTML += `<div class="bg-white p-5 rounded-3xl shadow-sm mb-4 border-l-[10px] status-${p.status.replace(/ /g, '')}">
                    <div class="flex justify-between font-black text-[10px] uppercase"><span>${p.cliente_nome}</span><span class="opacity-60">${p.status}</span></div>
                    <div class="text-[9px] text-gray-500 my-1 font-bold text-red-600">${p.rua} ${p.numero || ''}</div>
                    <div class="text-[9px] border-y border-dashed py-3 my-2 italic text-gray-700">${Object.entries(ag).map(([n, q]) => `${q}x ${n}`).join(', ')}</div>
                    <div class="flex justify-between items-center mt-3">
                        <span class="font-black text-sm">R$ ${p.total.toFixed(2)}</span>
                        <div class="flex gap-2">
                            <button onclick="printPed('${p.id}')" class="bg-gray-100 p-2 rounded-xl text-xl">üñ®Ô∏è</button>
                            <select onchange="upStatus('${p.id}', this.value)" class="text-[9px] bg-black text-white p-2 rounded-xl font-bold">
                                <option value="">A√ß√£o</option><option value="Preparando">Preparando</option><option value="Pronto">Pronto</option><option value="Saiu">Saiu Entrega</option><option value="Finalizado">‚úÖ Finalizar</option>
                            </select>
                        </div>
                    </div>
                </div>`;
            });
        }

        async function printPed(id) {
            const { data: p } = await _sb.from('pedidos').select('*, itens_pedido(*)').eq('id', id).single();
            document.getElementById('p-loja').innerText = CONFIG.nome_pizzaria;
            document.getElementById('p-tipo').innerText = p.rua.toUpperCase();
            document.getElementById('p-data').innerText = `DATA: ${new Date(p.created_at).toLocaleString('pt-BR')}`;
            document.getElementById('p-cliente').innerText = `CLIENTE: ${p.cliente_nome}`;
            document.getElementById('p-endereco').innerText = p.distancia_km > 0 ? `END: ${p.rua}, ${p.numero}` : p.rua;
            const ag = agrupar(p.itens_pedido.map(i => ({ nome: i.produto_nome })));
            document.getElementById('p-itens').innerHTML = Object.entries(ag).map(([n, q]) => `<div style="display:flex;justify-content:space-between"><span>${q}x ${n}</span></div>`).join('');
            document.getElementById('p-taxa').innerText = `TAXA: R$ ${p.taxa_entrega.toFixed(2)}`;
            document.getElementById('p-total').innerText = `TOTAL: R$ ${p.total.toFixed(2)}`;
            document.getElementById('p-pag').innerText = `PAGAM: ${p.pagamento}`;
            document.getElementById('p-troco').innerText = p.troco != "N√£o" ? `TROCO PARA: R$ ${p.troco}` : "";
            setTimeout(() => { window.print(); }, 700);
        }

        async function loadRastreio(id) {
            document.getElementById('view-cliente').classList.add('hidden');
            document.getElementById('view-rastreio').classList.remove('hidden');
            const { data } = await _sb.from('pedidos').select('status').eq('id', id).single();
            const s = data ? data.status : "Novo";
            document.getElementById('rastreio-status').innerText = s.toUpperCase();
            document.getElementById('box-status-cliente').className = `py-12 px-4 rounded-3xl border-4 border-double mb-6 status-${s.replace(/ /g, '')}`;
        }

        function agrupar(l) { return l.reduce((acc, i) => { acc[i.nome] = (acc[i.nome] || 0) + 1; return acc; }, {}); }
        function abrirCheckout() { 
            document.getElementById('modal-checkout').classList.remove('hidden'); 
            const ag = agrupar(CARRINHO);
            document.getElementById('checkout-itens').innerHTML = Object.entries(ag).map(([n, q]) => `<div class="flex justify-between"><span>${q}x ${n}</span></div>`).join('');
            setModo(modo); 
        }
        function fecharCheckout() { document.getElementById('modal-checkout').classList.add('hidden'); }
        function switchTab(t) { ['pedidos', 'produtos', 'config'].forEach(x => { document.getElementById(`sec-${x}`).classList.toggle('hidden', x !== t); document.getElementById(`tab-${x}`).classList.toggle('tab-active', x === t); }); if(t === 'pedidos') loadPedidos(); }
        async function upStatus(id, s) { await _sb.from('pedidos').update({ status: s }).eq('id', id); loadPedidos(); }
        async function abrirAdmin() { if(prompt("Senha:") === "123") { document.getElementById('view-cliente').classList.add('hidden'); document.getElementById('view-admin').classList.remove('hidden'); switchTab('pedidos'); } }

        init();
    </script>
</body>
</html>
